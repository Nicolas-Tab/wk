{"version":3,"sources":["meteor://ðŸ’»app/packages/communitypackages:picker/lib/instance.js","meteor://ðŸ’»app/packages/communitypackages:picker/lib/implementation.js"],"names":["module","export","Picker","WebApp","link","v","PickerImp","rawConnectHandlers","use","req","res","next","_dispatch","pathToRegexp","Fiber","default","parseQuery","queryString","query","pairs","replace","split","i","length","pair","decodeURIComponent","filterFunction","routes","subRouters","middlewares","prototype","middleware","callback","push","subRouter","route","path","keys","regExp","filter","bypass","currentRoute","currentSubRouter","currentMiddleware","result","processNextMiddleware","onDone","_processMiddleware","processNextRoute","uri","url","m","match","_req$_parsedUrl","params","_buildParams","_parsedUrl","_processRoute","processNextSubRouter","lc","_keys","key","name","current","doCall","run","call"],"mappings":"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","file":"/packages/communitypackages_picker.js","sourcesContent":["import { WebApp } from 'meteor/webapp';\nimport { PickerImp } from './implementation';\n\nexport const Picker = new PickerImp();\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n  Picker._dispatch(req, res, next);\n});\n","import { pathToRegexp } from 'path-to-regexp';\n// TODO replace fibers\nimport Fiber from 'fibers';\n\nfunction parseQuery(queryString) {\n  if (!queryString) return {}\n  let query = {};\n  const pairs = queryString.replace(/^\\?/, '').split('&');\n  for (let i = 0; i < pairs.length; i++) {\n    const pair = pairs[i].split('=');\n    query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');\n  }\n  return query;\n}\n\nexport const PickerImp = function(filterFunction) {\n  this.filterFunction = filterFunction;\n  this.routes = [];\n  this.subRouters = [];\n  this.middlewares = [];\n}\n\nPickerImp.prototype.middleware = function(callback) {\n  this.middlewares.push(callback);\n  for(const subRouter of this.subRouters) {\n    subRouter.middleware(callback);\n  }\n};\n\nPickerImp.prototype.route = function(path, callback) {\n  const keys = [];\n  const regExp = pathToRegexp(path, keys);\n  regExp.callback = callback;\n  regExp.keys = keys;\n  this.routes.push(regExp);\n  return this;\n};\n\nPickerImp.prototype.filter = function(callback) {\n  const subRouter = new PickerImp(callback);\n  this.subRouters.push(subRouter);\n  for(const middleware of this.middlewares) {\n    subRouter.middleware(middleware);\n  }\n  return subRouter;\n};\n\nPickerImp.prototype._dispatch = function(req, res, bypass) {\n  let currentRoute = 0;\n  let currentSubRouter = 0;\n  let currentMiddleware = 0;\n\n  if(this.filterFunction) {\n    const result = this.filterFunction(req, res);\n    if(!result) {\n      return bypass();\n    }\n  }\n\n  const processNextMiddleware = (onDone) => {\n    const middleware = this.middlewares[currentMiddleware++];\n    if(middleware) {\n      this._processMiddleware(middleware, req, res, () => processNextMiddleware(onDone));\n    } else {\n      onDone();\n    }\n  }\n\n  const processNextRoute = () => {\n    const route = this.routes[currentRoute++];\n    if(route) {\n      const uri = req.url.replace(/\\?.*/, '');\n      const m = uri.match(route);\n      if(m) {\n        processNextMiddleware(() => {\n          const params = this._buildParams(route.keys, m);\n          params.query = parseQuery(req._parsedUrl?.query);\n          // See https://github.com/meteorhacks/picker/pull/39 for processNextRoute reason in the following method.\n          this._processRoute(route.callback, params, req, res, processNextRoute);\n        });\n      } else {\n        processNextRoute();\n      }\n    } else {\n      processNextSubRouter();\n    } \n  }\n\n  const processNextSubRouter = () => {\n    const subRouter = this.subRouters[currentSubRouter++];\n    if(subRouter) {\n      subRouter._dispatch(req, res, processNextSubRouter);\n    } else {\n      bypass();\n    }\n  }\n  processNextRoute();\n};\n\nPickerImp.prototype._buildParams = function(keys, m) {\n  const params = {};\n  for(let lc = 1; lc < m.length; lc++) {\n    const key = keys[lc-1]?.name;\n    params[key] = decodeURIComponent(m[lc]);\n  }\n\n  return params;\n};\n\nPickerImp.prototype._processRoute = function(callback, params, req, res, next) {\n  if(Fiber.current) {\n    doCall();\n  } else {\n    new Fiber(doCall).run();\n  }\n\n  function doCall () {\n    callback.call(null, params, req, res, next); \n  }\n};\n\nPickerImp.prototype._processMiddleware = function(middleware, req, res, next) {\n  if(Fiber.current) {\n    doCall();\n  } else {\n    new Fiber(doCall).run();\n  }\n\n  function doCall() {\n    middleware.call(null, req, res, next);\n  }\n};"]}