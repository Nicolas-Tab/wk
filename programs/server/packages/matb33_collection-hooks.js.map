{"version":3,"sources":["meteor://ðŸ’»app/packages/matb33:collection-hooks/server.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/advices.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/collection-hooks.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/find.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/findone.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/insert.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/remove.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/update.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/upsert.js","meteor://ðŸ’»app/packages/matb33:collection-hooks/users-compat.js"],"names":["module","export","CollectionHooks","Meteor","link","v","publishUserId","EnvironmentVariable","getUserId","userId","e","get","defaultUserId","_publish","publish","name","handler","options","call","_len","arguments","length","args","Array","_key","withValue","apply","isWithinPublish","undefined","_objectWithoutProperties","default","_objectSpread","Mongo","EJSON","LocalCollection","advices","defaults","before","insert","update","remove","upsert","find","findOne","all","after","directEnv","directOp","func","hookedOp","extendCollectionInstance","self","constructor","forEach","pointcut","Object","entries","_ref","method","advice","_ensure","_hookAspects","aspect","target","initOptions","push","replace","src","targetIndex","findIndex","entry","newTarget","splice","hookOptions","clone","_ref2","collection","isClient","_collection","_super","direct","prototype","asyncMethod","_len2","_key2","_len3","_key3","doc","_transform","d","defineAdvice","getAdvice","extendOptions","source","getDocs","selector","fetchFields","useDirect","findOptions","transform","reactive","keys","fields","multi","limit","rest","_excluded","assign","normalizeSelector","ObjectID","_id","getFields","mutator","operators","_ref3","op","params","includes","field","indexOf","substring","reassignPrototype","instance","constr","hasSetPrototypeOf","setPrototypeOf","Collection","__proto__","wrapCollection","ns","as","_CollectionConstructor","_CollectionPrototype","_NewCollectionContructor","proto","_len4","_key4","ret","prop","Function","modify","_modify","aspects","getTransform","suppressAspects","ctx","context","_getFindSelector","_getFindOptions","abort","o","r","cursor","callback","async","id","err","ops","_str","toString","lctx","wrappedCallback","obj","insertedId","isEmpty","a","isArray","docs","prev","fetch","result","docIds","shouldFetchForBefore","shouldFetchForAfter","shouldFetchForPrevious","values","some","fetchPrevious","afterAspectFetchFields","map","beforeAspectFetchFields","afterGlobal","beforeGlobal","affected","aspectFetchFields","globalFetchFields","$in","previous","aspectGroup","numberAffected","afterUpdate","afterInsert","users"],"mappings":"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","file":"/packages/matb33_collection-hooks.js","sourcesContent":["import { Meteor } from 'meteor/meteor'\nimport { CollectionHooks } from './collection-hooks'\n\nimport './advices'\n\nconst publishUserId = new Meteor.EnvironmentVariable()\n\nCollectionHooks.getUserId = function getUserId () {\n  let userId\n\n  try {\n    // Will throw an error unless within method call.\n    // Attempt to recover gracefully by catching:\n    userId = Meteor.userId && Meteor.userId()\n  } catch (e) {}\n\n  if (userId == null) {\n    // Get the userId if we are in a publish function.\n    userId = publishUserId.get()\n  }\n\n  if (userId == null) {\n    userId = CollectionHooks.defaultUserId\n  }\n\n  return userId\n}\n\nconst _publish = Meteor.publish\nMeteor.publish = function (name, handler, options) {\n  return _publish.call(this, name, function (...args) {\n    // This function is called repeatedly in publications\n    return publishUserId.withValue(this && this.userId, () => handler.apply(this, args))\n  }, options)\n}\n\n// Make the above available for packages with hooks that want to determine\n// whether they are running inside a publish function or not.\nCollectionHooks.isWithinPublish = () => publishUserId.get() !== undefined\n\nexport {\n  CollectionHooks\n}\n","import './insert.js'\nimport './update.js'\nimport './remove.js'\nimport './upsert.js'\nimport './find.js'\nimport './findone.js'\n\n// Load after all advices have been defined\nimport './users-compat.js'\n","import { Meteor } from 'meteor/meteor'\nimport { Mongo } from 'meteor/mongo'\nimport { EJSON } from 'meteor/ejson'\nimport { LocalCollection } from 'meteor/minimongo'\n\n// Relevant AOP terminology:\n// Aspect: User code that runs before/after (hook)\n// Advice: Wrapper code that knows when to call user code (aspects)\n// Pointcut: before/after\nconst advices = {}\n\nexport const CollectionHooks = {\n  defaults: {\n    before: { insert: {}, update: {}, remove: {}, upsert: {}, find: {}, findOne: {}, all: {} },\n    after: { insert: {}, update: {}, remove: {}, find: {}, findOne: {}, all: {} },\n    all: { insert: {}, update: {}, remove: {}, find: {}, findOne: {}, all: {} }\n  },\n  directEnv: new Meteor.EnvironmentVariable(),\n  directOp (func) {\n    return this.directEnv.withValue(true, func)\n  },\n  hookedOp (func) {\n    return this.directEnv.withValue(false, func)\n  }\n}\n\nCollectionHooks.extendCollectionInstance = function extendCollectionInstance (self, constructor) {\n  // Offer a public API to allow the user to define aspects\n  // Example: collection.before.insert(func);\n  ['before', 'after'].forEach(function (pointcut) {\n    Object.entries(advices).forEach(function ([method, advice]) {\n      if (advice === 'upsert' && pointcut === 'after') return\n\n      Meteor._ensure(self, pointcut, method)\n      Meteor._ensure(self, '_hookAspects', method)\n\n      self._hookAspects[method][pointcut] = []\n      self[pointcut][method] = function (aspect, options) {\n        let target = {\n          aspect,\n          options: CollectionHooks.initOptions(options, pointcut, method)\n        }\n        // adding is simply pushing it to the array\n        self._hookAspects[method][pointcut].push(target)\n\n        return {\n          replace (aspect, options) {\n            // replacing is done by determining the actual index of a given target\n            // and replace this with the new one\n            const src = self._hookAspects[method][pointcut]\n            const targetIndex = src.findIndex(entry => entry === target)\n            const newTarget = {\n              aspect,\n              options: CollectionHooks.initOptions(options, pointcut, method)\n            }\n            src.splice(targetIndex, 1, newTarget)\n            // update the target to get the correct index in future calls\n            target = newTarget\n          },\n          remove () {\n            // removing a hook is done by determining the actual index of a given target\n            // and removing it form the source array\n            const src = self._hookAspects[method][pointcut]\n            const targetIndex = src.findIndex(entry => entry === target)\n            self._hookAspects[method][pointcut].splice(targetIndex, 1)\n          }\n        }\n      }\n    })\n  })\n\n  // Offer a publicly accessible object to allow the user to define\n  // collection-wide hook options.\n  // Example: collection.hookOptions.after.update = {fetchPrevious: false};\n  self.hookOptions = EJSON.clone(CollectionHooks.defaults)\n\n  // Wrap mutator methods, letting the defined advice do the work\n  Object.entries(advices).forEach(function ([method, advice]) {\n    const collection = Meteor.isClient || method === 'upsert' ? self : self._collection\n\n    // Store a reference to the original mutator method\n    const _super = collection[method]\n\n    Meteor._ensure(self, 'direct', method)\n    self.direct[method] = function (...args) {\n      return CollectionHooks.directOp(function () {\n        return constructor.prototype[method].apply(self, args)\n      })\n    }\n\n    const asyncMethod = method + 'Async'\n\n    if (constructor.prototype[asyncMethod]) {\n      self.direct[asyncMethod] = function (...args) {\n        return CollectionHooks.directOp(function () {\n          return constructor.prototype[asyncMethod].apply(self, args)\n        })\n      }\n    }\n\n    collection[method] = function (...args) {\n      if (CollectionHooks.directEnv.get() === true) {\n        return _super.apply(collection, args)\n      }\n\n      // NOTE: should we decide to force `update` with `{upsert:true}` to use\n      // the `upsert` hooks, this is what will accomplish it. It's important to\n      // realize that Meteor won't distinguish between an `update` and an\n      // `insert` though, so we'll end up with `after.update` getting called\n      // even on an `insert`. That's why we've chosen to disable this for now.\n      // if (method === \"update\" && Object(args[2]) === args[2] && args[2].upsert) {\n      //   method = \"upsert\";\n      //   advice = CollectionHooks.getAdvice(method);\n      // }\n\n      return advice.call(this,\n        CollectionHooks.getUserId(),\n        _super,\n        self,\n        method === 'upsert'\n          ? {\n              insert: self._hookAspects.insert || {},\n              update: self._hookAspects.update || {},\n              upsert: self._hookAspects.upsert || {}\n            }\n          : self._hookAspects[method] || {},\n        function (doc) {\n          return (\n            typeof self._transform === 'function'\n              ? function (d) { return self._transform(d || doc) }\n              : function (d) { return d || doc }\n          )\n        },\n        args,\n        false\n      )\n    }\n  })\n}\n\nCollectionHooks.defineAdvice = (method, advice) => {\n  advices[method] = advice\n}\n\nCollectionHooks.getAdvice = method => advices[method]\n\nCollectionHooks.initOptions = (options, pointcut, method) =>\n  CollectionHooks.extendOptions(CollectionHooks.defaults, options, pointcut, method)\n\nCollectionHooks.extendOptions = (source, options, pointcut, method) =>\n  ({ ...options, ...source.all.all, ...source[pointcut].all, ...source.all[method], ...source[pointcut][method] })\n\nCollectionHooks.getDocs = function getDocs (collection, selector, options, fetchFields = {}, { useDirect = false } = {}) {\n  const findOptions = { transform: null, reactive: false }\n\n  if (Object.keys(fetchFields).length > 0) {\n    findOptions.fields = fetchFields\n  }\n\n  /*\n  // No \"fetch\" support at this time.\n  if (!this._validators.fetchAllFields) {\n    findOptions.fields = {};\n    this._validators.fetch.forEach(function(fieldName) {\n      findOptions.fields[fieldName] = 1;\n    });\n  }\n  */\n\n  // Bit of a magic condition here... only \"update\" passes options, so this is\n  // only relevant to when update calls getDocs:\n  if (options) {\n    // This was added because in our case, we are potentially iterating over\n    // multiple docs. If multi isn't enabled, force a limit (almost like\n    // findOne), as the default for update without multi enabled is to affect\n    // only the first matched document:\n    if (!options.multi) {\n      findOptions.limit = 1\n    }\n    const { multi, upsert, ...rest } = options\n    Object.assign(findOptions, rest)\n  }\n\n  // Unlike validators, we iterate over multiple docs, so use\n  // find instead of findOne:\n  return (useDirect ? collection.direct : collection).find(selector, findOptions)\n}\n\n// This function normalizes the selector (converting it to an Object)\nCollectionHooks.normalizeSelector = function (selector) {\n  if (typeof selector === 'string' || (selector && selector.constructor === Mongo.ObjectID)) {\n    return {\n      _id: selector\n    }\n  } else {\n    return selector\n  }\n}\n\n// This function contains a snippet of code pulled and modified from:\n// ~/.meteor/packages/mongo-livedata/collection.js\n// It's contained in these utility functions to make updates easier for us in\n// case this code changes.\nCollectionHooks.getFields = function getFields (mutator) {\n  // compute modified fields\n  const fields = []\n  // ====ADDED START=======================\n  const operators = [\n    '$addToSet',\n    '$bit',\n    '$currentDate',\n    '$inc',\n    '$max',\n    '$min',\n    '$pop',\n    '$pull',\n    '$pullAll',\n    '$push',\n    '$rename',\n    '$set',\n    '$unset'\n  ]\n  // ====ADDED END=========================\n\n  Object.entries(mutator).forEach(function ([op, params]) {\n    // ====ADDED START=======================\n    if (operators.includes(op)) {\n    // ====ADDED END=========================\n      Object.keys(params).forEach(function (field) {\n        // treat dotted fields as if they are replacing their\n        // top-level part\n        if (field.indexOf('.') !== -1) {\n          field = field.substring(0, field.indexOf('.'))\n        }\n\n        // record the field we are trying to change\n        if (!fields.includes(field)) {\n          fields.push(field)\n        }\n      })\n      // ====ADDED START=======================\n    } else {\n      fields.push(op)\n    }\n    // ====ADDED END=========================\n  })\n\n  return fields\n}\n\nCollectionHooks.reassignPrototype = function reassignPrototype (instance, constr) {\n  const hasSetPrototypeOf = typeof Object.setPrototypeOf === 'function'\n  constr = constr || Mongo.Collection\n\n  // __proto__ is not available in < IE11\n  // Note: Assigning a prototype dynamically has performance implications\n  if (hasSetPrototypeOf) {\n    Object.setPrototypeOf(instance, constr.prototype)\n  } else if (instance.__proto__) { // eslint-disable-line no-proto\n    instance.__proto__ = constr.prototype // eslint-disable-line no-proto\n  }\n}\n\nCollectionHooks.wrapCollection = function wrapCollection (ns, as) {\n  if (!as._CollectionConstructor) as._CollectionConstructor = as.Collection\n  if (!as._CollectionPrototype) as._CollectionPrototype = new as.Collection(null)\n\n  const constructor = ns._NewCollectionContructor || as._CollectionConstructor\n  const proto = as._CollectionPrototype\n\n  ns.Collection = function (...args) {\n    const ret = constructor.apply(this, args)\n    CollectionHooks.extendCollectionInstance(this, constructor)\n    return ret\n  }\n  // Retain a reference to the new constructor to allow further wrapping.\n  ns._NewCollectionContructor = ns.Collection\n\n  ns.Collection.prototype = proto\n  ns.Collection.prototype.constructor = ns.Collection\n\n  for (const prop of Object.keys(constructor)) {\n    ns.Collection[prop] = constructor[prop]\n  }\n\n  // Meteor overrides the apply method which is copied from the constructor in the loop above. Replace it with the\n  // default method which we need if we were to further wrap ns.Collection.\n  ns.Collection.apply = Function.prototype.apply\n}\n\nCollectionHooks.modify = LocalCollection._modify\n\nif (typeof Mongo !== 'undefined') {\n  CollectionHooks.wrapCollection(Meteor, Mongo)\n  CollectionHooks.wrapCollection(Mongo, Mongo)\n} else {\n  CollectionHooks.wrapCollection(Meteor, Meteor)\n}\n","import { CollectionHooks } from './collection-hooks'\n\nCollectionHooks.defineAdvice('find', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  const selector = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n  const options = instance._getFindOptions(args)\n  let abort\n  // before\n  if (!suppressAspects) {\n    aspects.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return instance.find(undefined)\n  }\n\n  const after = (cursor) => {\n    if (!suppressAspects) {\n      aspects.after.forEach((o) => {\n        o.aspect.call(ctx, userId, selector, options, cursor)\n      })\n    }\n  }\n\n  const ret = _super.call(this, selector, options)\n  after(ret)\n\n  return ret\n})\n","import { CollectionHooks } from './collection-hooks'\n\nCollectionHooks.defineAdvice('findOne', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  const selector = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n  const options = instance._getFindOptions(args)\n  let abort\n\n  // before\n  if (!suppressAspects) {\n    aspects.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return\n  }\n\n  function after (doc) {\n    if (!suppressAspects) {\n      aspects.after.forEach((o) => {\n        o.aspect.call(ctx, userId, selector, options, doc)\n      })\n    }\n  }\n\n  const ret = _super.call(this, selector, options)\n  after(ret)\n\n  return ret\n})\n","import { EJSON } from 'meteor/ejson'\nimport { Mongo } from 'meteor/mongo'\nimport { CollectionHooks } from './collection-hooks'\n\nCollectionHooks.defineAdvice('insert', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  let doc = args[0]\n  let callback\n  if (typeof args[args.length - 1] === 'function') {\n    callback = args[args.length - 1]\n  }\n\n  const async = typeof callback === 'function'\n  let abort\n  let ret\n\n  // before\n  if (!suppressAspects) {\n    try {\n      aspects.before.forEach((o) => {\n        const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc)\n        if (r === false) abort = true\n      })\n\n      if (abort) return\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  const after = (id, err) => {\n    if (id) {\n      // In some cases (namely Meteor.users on Meteor 1.4+), the _id property\n      // is a raw mongo _id object. We need to extract the _id from this object\n      if (typeof id === 'object' && id.ops) {\n        // If _str then collection is using Mongo.ObjectID as ids\n        if (doc._id._str) {\n          id = new Mongo.ObjectID(doc._id._str.toString())\n        } else {\n          id = id.ops && id.ops[0] && id.ops[0]._id\n        }\n      }\n      doc = EJSON.clone(doc)\n      doc._id = id\n    }\n    if (!suppressAspects) {\n      const lctx = { transform: getTransform(doc), _id: id, err, ...ctx }\n      aspects.after.forEach((o) => {\n        o.aspect.call(lctx, userId, doc)\n      })\n    }\n    return id\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, obj, ...args) {\n      after((obj && obj[0] && obj[0]._id) || obj, err)\n      return callback.call(this, err, obj, ...args)\n    }\n    return _super.call(this, doc, wrappedCallback)\n  } else {\n    ret = _super.call(this, doc, callback)\n    return after((ret && ret.insertedId) || (ret && ret[0] && ret[0]._id) || ret)\n  }\n})\n","import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('remove', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  const [selector, callback] = args\n  const async = typeof callback === 'function'\n  let docs\n  let abort\n  const prev = []\n\n  if (!suppressAspects) {\n    try {\n      if (!isEmpty(aspects.before) || !isEmpty(aspects.after)) {\n        docs = CollectionHooks.getDocs.call(this, instance, selector).fetch()\n      }\n\n      // copy originals for convenience for the 'after' pointcut\n      if (!isEmpty(aspects.after)) {\n        docs.forEach(doc => prev.push(EJSON.clone(doc)))\n      }\n\n      // before\n      aspects.before.forEach((o) => {\n        docs.forEach((doc) => {\n          const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc)\n          if (r === false) abort = true\n        })\n      })\n\n      if (abort) return 0\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  function after (err) {\n    if (!suppressAspects) {\n      aspects.after.forEach((o) => {\n        prev.forEach((doc) => {\n          o.aspect.call({ transform: getTransform(doc), err, ...ctx }, userId, doc)\n        })\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, ...args) {\n      after(err)\n      return callback.call(this, err, ...args)\n    }\n    return _super.call(this, selector, wrappedCallback)\n  } else {\n    const result = _super.call(this, selector, callback)\n    after()\n    return result\n  }\n})\n","import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('update', function (userId, _super, instance, aspects, getTransform, args, suppressAspects) {\n  const ctx = { context: this, _super, args }\n  let [selector, mutator, options, callback] = args\n  if (typeof options === 'function') {\n    callback = options\n    options = {}\n  }\n  const async = typeof callback === 'function'\n  let docs\n  let docIds\n  let fields\n  let abort\n  const prev = {}\n\n  if (!suppressAspects) {\n    try {\n      // NOTE: fetching the full documents before when fetchPrevious is false and no before hooks are defined is wildly inefficient.\n      const shouldFetchForBefore = !isEmpty(aspects.before)\n      const shouldFetchForAfter = !isEmpty(aspects.after)\n      let shouldFetchForPrevious = false\n      if (shouldFetchForAfter) {\n        shouldFetchForPrevious = Object.values(aspects.after).some(o => o.options.fetchPrevious !== false) && CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false\n      }\n      fields = CollectionHooks.getFields(args[1])\n      const fetchFields = { }\n      if (shouldFetchForPrevious || shouldFetchForBefore) {\n        const afterAspectFetchFields = shouldFetchForPrevious ? Object.values(aspects.after).map(o => (o.options || {}).fetchFields || {}) : []\n        const beforeAspectFetchFields = shouldFetchForBefore ? Object.values(aspects.before).map(o => (o.options || {}).fetchFields || {}) : []\n        const afterGlobal = shouldFetchForPrevious ? (CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchFields || {}) : {}\n        const beforeGlobal = shouldFetchForPrevious ? (CollectionHooks.extendOptions(instance.hookOptions, {}, 'before', 'update').fetchFields || {}) : {}\n        Object.assign(fetchFields, afterGlobal, beforeGlobal, ...afterAspectFetchFields, ...beforeAspectFetchFields)\n      }\n      docs = CollectionHooks.getDocs.call(this, instance, args[0], args[2], fetchFields).fetch()\n      docIds = Object.values(docs).map(doc => doc._id)\n\n      // copy originals for convenience for the 'after' pointcut\n      if (shouldFetchForAfter) {\n        prev.mutator = EJSON.clone(args[1])\n        prev.options = EJSON.clone(args[2])\n        if (shouldFetchForPrevious) {\n          prev.docs = {}\n          docs.forEach((doc) => {\n            prev.docs[doc._id] = EJSON.clone(doc)\n          })\n        }\n      }\n\n      // before\n      aspects.before.forEach(function (o) {\n        docs.forEach(function (doc) {\n          const r = o.aspect.call({ transform: getTransform(doc), ...ctx }, userId, doc, fields, mutator, options)\n          if (r === false) abort = true\n        })\n      })\n\n      if (abort) return 0\n    } catch (e) {\n      if (async) return callback.call(this, e)\n      throw e\n    }\n  }\n\n  const after = (affected, err) => {\n    if (!suppressAspects) {\n      let docs\n      let fields\n      if (!isEmpty(aspects.after)) {\n        fields = CollectionHooks.getFields(args[1])\n        const fetchFields = {}\n        const aspectFetchFields = Object.values(aspects.after).map(o => (o.options || {}).fetchFields || {})\n        const globalFetchFields = CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchFields\n        if (aspectFetchFields || globalFetchFields) {\n          Object.assign(fetchFields, globalFetchFields || {}, ...aspectFetchFields.map(a => a.fetchFields))\n        }\n        docs = CollectionHooks.getDocs.call(this, instance, { _id: { $in: docIds } }, options, fetchFields, { useDirect: true }).fetch()\n      }\n\n      aspects.after.forEach((o) => {\n        docs.forEach((doc) => {\n          o.aspect.call({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err,\n            ...ctx\n          }, userId, doc, fields, prev.mutator, prev.options)\n        })\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, affected, ...args) {\n      after(affected, err)\n      return callback.call(this, err, affected, ...args)\n    }\n    return _super.call(this, selector, mutator, options, wrappedCallback)\n  } else {\n    const affected = _super.call(this, selector, mutator, options, callback)\n    after(affected)\n    return affected\n  }\n})\n","import { EJSON } from 'meteor/ejson'\nimport { CollectionHooks } from './collection-hooks'\n\nconst isEmpty = a => !Array.isArray(a) || !a.length\n\nCollectionHooks.defineAdvice('upsert', function (userId, _super, instance, aspectGroup, getTransform, args, suppressAspects) {\n  args[0] = CollectionHooks.normalizeSelector(instance._getFindSelector(args))\n\n  const ctx = { context: this, _super, args }\n  let [selector, mutator, options, callback] = args\n  if (typeof options === 'function') {\n    callback = options\n    options = {}\n  }\n\n  const async = typeof callback === 'function'\n  let docs\n  let docIds\n  let abort\n  const prev = {}\n\n  if (!suppressAspects) {\n    if (!isEmpty(aspectGroup.upsert.before) || !isEmpty(aspectGroup.update.after)) {\n      docs = CollectionHooks.getDocs.call(this, instance, selector, options).fetch()\n      docIds = docs.map(doc => doc._id)\n    }\n\n    // copy originals for convenience for the 'after' pointcut\n    if (!isEmpty(aspectGroup.update.after)) {\n      if (aspectGroup.update.after.some(o => o.options.fetchPrevious !== false) &&\n        CollectionHooks.extendOptions(instance.hookOptions, {}, 'after', 'update').fetchPrevious !== false) {\n        prev.mutator = EJSON.clone(mutator)\n        prev.options = EJSON.clone(options)\n\n        prev.docs = {}\n        docs.forEach((doc) => {\n          prev.docs[doc._id] = EJSON.clone(doc)\n        })\n      }\n    }\n\n    // before\n    aspectGroup.upsert.before.forEach((o) => {\n      const r = o.aspect.call(ctx, userId, selector, mutator, options)\n      if (r === false) abort = true\n    })\n\n    if (abort) return { numberAffected: 0 }\n  }\n\n  const afterUpdate = (affected, err) => {\n    if (!suppressAspects && !isEmpty(aspectGroup.update.after)) {\n      const fields = CollectionHooks.getFields(mutator)\n      const docs = CollectionHooks.getDocs.call(this, instance, { _id: { $in: docIds } }, options).fetch()\n\n      aspectGroup.update.after.forEach((o) => {\n        docs.forEach((doc) => {\n          o.aspect.call({\n            transform: getTransform(doc),\n            previous: prev.docs && prev.docs[doc._id],\n            affected,\n            err,\n            ...ctx\n          }, userId, doc, fields, prev.mutator, prev.options)\n        })\n      })\n    }\n  }\n\n  const afterInsert = (_id, err) => {\n    if (!suppressAspects && !isEmpty(aspectGroup.insert.after)) {\n      const doc = CollectionHooks.getDocs.call(this, instance, { _id }, selector, {}).fetch()[0] // 3rd argument passes empty object which causes magic logic to imply limit:1\n      const lctx = { transform: getTransform(doc), _id, err, ...ctx }\n\n      aspectGroup.insert.after.forEach((o) => {\n        o.aspect.call(lctx, userId, doc)\n      })\n    }\n  }\n\n  if (async) {\n    const wrappedCallback = function (err, ret) {\n      if (err || (ret && ret.insertedId)) {\n        // Send any errors to afterInsert\n        afterInsert(ret.insertedId, err)\n      } else {\n        afterUpdate(ret && ret.numberAffected, err) // Note that err can never reach here\n      }\n\n      return CollectionHooks.hookedOp(function () {\n        return callback.call(this, err, ret)\n      })\n    }\n\n    return CollectionHooks.directOp(() => _super.call(this, selector, mutator, options, wrappedCallback))\n  } else {\n    const ret = CollectionHooks.directOp(() => _super.call(this, selector, mutator, options, callback))\n\n    if (ret && ret.insertedId) {\n      afterInsert(ret.insertedId)\n    } else {\n      afterUpdate(ret && ret.numberAffected)\n    }\n\n    return ret\n  }\n})\n","import { Meteor } from 'meteor/meteor'\nimport { Mongo } from 'meteor/mongo'\nimport { CollectionHooks } from './collection-hooks'\n\nif (Meteor.users) {\n  // If Meteor.users has been instantiated, attempt to re-assign its prototype:\n  CollectionHooks.reassignPrototype(Meteor.users)\n\n  // Next, give it the hook aspects:\n  CollectionHooks.extendCollectionInstance(Meteor.users, Mongo.Collection)\n}\n"]}