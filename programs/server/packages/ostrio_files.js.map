{"version":3,"sources":["meteor://ðŸ’»app/packages/ostrio:files/server.js","meteor://ðŸ’»app/packages/ostrio:files/core.js","meteor://ðŸ’»app/packages/ostrio:files/cursor.js","meteor://ðŸ’»app/packages/ostrio:files/lib.js","meteor://ðŸ’»app/packages/ostrio:files/write-stream.js"],"names":["module","export","FilesCollection","helpers","Mongo","link","v","fetch","WebApp","Meteor","Random","Cookies","check","Match","WriteStream","default","FilesCollectionCore","fixJSONParse","fixJSONStringify","AbortController","fs","nodeQs","nodePath","bound","bindEnvironment","callback","noop","createIndex","_collection","keys","opts","Promise","asyncApply","collection","rawCollection","await","e","code","indexName","indexes","index","allMatch","indexKey","Object","key","name","dropIndex","_debug","concat","join","_name","details","constructor","config","storagePath","_preCollection","_preCollectionName","allowClientCode","allowedOrigins","allowQueryStringCookies","cacheControl","chunkSize","collectionName","continueUploadTTL","debug","disableDownload","disableUpload","downloadCallback","downloadRoute","getUser","integrityCheck","interceptDownload","interceptRequest","namingFunction","onAfterRemove","onAfterUpload","onBeforeRemove","onBeforeUpload","onInitiateUpload","parentDirPermissions","permissions","protected","public","responseHeaders","sanitize","schema","strict","self","isBoolean","Math","floor","isString","Collection","filesCollection","String","Error","replace","isFunction","isNumber","parseInt","isObject","_currentUploads","responseCode","fileRef","versionRef","headers","Pragma","size","Connection","type","sep","sp","apply","arguments","normalize","mkdirSync","mode","recursive","error","Boolean","Number","Function","OneOf","RegExp","_cookies","allowedCordovaOrigins","createdAt","expireAfterSeconds","background","_preCollectionCursor","find","fields","_id","isFinished","observe","changed","doc","remove","removed","stop","end","count","abort","_createStream","path","fileLength","_continueUpload","file","aborted","ended","contUpld","findOne","_checkAccess","http","result","user","userId","_getUser","params","call","assign","rc","text","response","headersSent","writeHead","length","finished","_methodNames","_Abort","_Write","_Start","_Remove","on","_handleUpload","_finishUpload","_handleUploadSync","wrapAsync","bind","connectHandlers","use","httpReq","httpResp","next","_parsedUrl","includes","test","origin","setHeader","method","handleError","_error","toString","JSON","stringify","body","handleData","request","fileId","eof","binData","Buffer","from","chunkId","_prepareUpload","meta","emit","parse","jsonErr","___s","clone","Date","maxLength","insert","omit","returnMeta","uploadRoute","httpRespErr","setTimeout","data","uri","indexOf","substring","uris","split","query","version","download","_file","_methods","selector","userFuncs","users","cursor","FSName","Optional","_opts","unblock","handleUploadErr","unlink","methods","undefined","transport","ctx","fileName","_getFileName","extension","extensionWithDot","_getExt","ext","_dataToSchema","isUploadAllowed","cb","chmod","_getMimeType","_updateFileTypes","colInsert","update","$set","preUpdateError","write","fileData","mime","_getUserId","xmtok","server","sessions","Map","has","get","_getUserDefault","mtok","cookie","buffer","_callback","_proceedAfterUpload","proceedAfterUpload","id","fsName","stat","statError","stats","isFile","paths","pop","writeFileSync","stream","createWriteStream","flags","streamErr","insertErr","load","url","timeout","pathParts","storeResult","isEnded","timer","wStream","autoClose","emitClose","onEnd","clearTimeout","status","statErrorOnEnd","newStats","versions","original","statusText","destroyed","destroy","unlinkError","resp","controller","signal","then","res","pipe","catch","fetchError","addFile","statErr","_storagePath","files","forEach","docs","deny","rules","allow","denyClient","allowClient","vKey","_404","originalUrl","vRef","responseType","serve","readableStream","_responseType","force200","partiral","reqRange","dispositionType","start","take","dispositionName","encodeURI","encodeURIComponent","dispositionEncoding","range","array","isNaN","play","streamErrorHandler","respond","_isEnded","closeStreamCb","closeError","closeStream","close","closeStreamError","err","createReadStream","EventEmitter","formatFleURL","FilesCursor","FileCursor","console","info","log","toLowerCase","isVideo","isAudio","isImage","isText","isJSON","isPDF","ds","_downloadRoute","_collectionName","options","uriBase","__helpers","optional","blackbox","updatedAt","_fileRef","property","with","_selector","_current","hasNext","hasPrevious","previous","first","last","context","each","map","current","callbacks","observeChanges","str","max","replacement","isUndefined","obj","isArray","Array","prototype","isDate","date","getDate","isEmpty","slice","_obj","hasOwnProperty","i","clear","_len","_key","now","throttle","func","wait","that","args","later","leading","throttled","remaining","trailing","cancel","_helpers","_uriBase","__meteor_runtime_config__","ROOT_URL","_root","fdCache","trim","fd","writtenChunks","mkdirError","writeFileError","open","oError","num","chunk","written","ceil"],"mappings":"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","file":"/packages/ostrio_files.js","sourcesContent":["import { Mongo } from 'meteor/mongo';\nimport { fetch } from 'meteor/fetch';\nimport { WebApp } from 'meteor/webapp';\nimport { Meteor } from 'meteor/meteor';\nimport { Random } from 'meteor/random';\nimport { Cookies } from 'meteor/ostrio:cookies';\nimport { check, Match } from 'meteor/check';\n\nimport WriteStream from './write-stream.js';\nimport FilesCollectionCore from './core.js';\nimport { fixJSONParse, fixJSONStringify, helpers } from './lib.js';\n\nimport AbortController from 'abort-controller';\nimport fs from 'fs';\nimport nodeQs from 'querystring';\nimport nodePath from 'path';\n\n/**\n * @const {Object} bound  - Meteor.bindEnvironment (Fiber wrapper)\n * @const {Function} noop - No Operation function, placeholder for required callbacks\n */\nconst bound = Meteor.bindEnvironment(callback => callback());\nconst noop = function noop () {};\n\n/**\n * Create (ensure) index on MongoDB collection, catch and log exception if thrown\n * @function createIndex\n * @param {Mongo.Collection} collection - Mongo.Collection instance\n * @param {object} keys - Field and value pairs where the field is the index key and the value describes the type of index for that field\n * @param {object} opts - Set of options that controls the creation of the index\n * @returns {void 0}\n */\nconst createIndex = async (_collection, keys, opts) => {\n  const collection = _collection.rawCollection();\n\n  try {\n    await collection.createIndex(keys, opts);\n  } catch (e) {\n    if (e.code === 85) {\n      let indexName;\n      const indexes = await collection.indexes();\n      for (const index of indexes) {\n        let allMatch = true;\n        for (const indexKey of Object.keys(keys)) {\n          if (typeof index.key[indexKey] === 'undefined') {\n            allMatch = false;\n            break;\n          }\n        }\n\n        for (const indexKey of Object.keys(index.key)) {\n          if (typeof keys[indexKey] === 'undefined') {\n            allMatch = false;\n            break;\n          }\n        }\n\n        if (allMatch) {\n          indexName = index.name;\n          break;\n        }\n      }\n\n      if (indexName) {\n        await collection.dropIndex(indexName);\n        await collection.createIndex(keys, opts);\n      }\n    } else {\n      Meteor._debug(`Can not set ${Object.keys(keys).join(' + ')} index on \"${_collection._name}\" collection`, { keys, opts, details: e });\n    }\n  }\n};\n\n/**\n * @locus Anywhere\n * @class FilesCollection\n * @param config           {Object}   - [Both]   Configuration object with next properties:\n * @param config.debug     {Boolean}  - [Both]   Turn on/of debugging and extra logging\n * @param config.schema    {Object}   - [Both]   Collection Schema\n * @param config.public    {Boolean}  - [Both]   Store files in folder accessible for proxy servers, for limits, and more - read docs\n * @param config.strict    {Boolean}  - [Server] Strict mode for partial content, if is `true` server will return `416` response code, when `range` is not specified, otherwise server return `206`\n * @param config.protected {Function} - [Server] If `true` - files will be served only to authorized users, if `function()` - you're able to check visitor's permissions in your own way function's context has:\n *  - `request`\n *  - `response`\n *  - `user()`\n *  - `userId`\n * @param config.chunkSize      {Number}  - [Both] Upload chunk size, default: 524288 bytes (0,5 Mb)\n * @param config.permissions    {Number}  - [Server] Permissions which will be set to uploaded files (octal), like: `511` or `0o755`. Default: 0644\n * @param config.parentDirPermissions {Number}  - [Server] Permissions which will be set to parent directory of uploaded files (octal), like: `611` or `0o777`. Default: 0755\n * @param config.storagePath    {String|Function}  - [Server] Storage path on file system\n * @param config.cacheControl   {String}  - [Server] Default `Cache-Control` header\n * @param config.responseHeaders {Object|Function} - [Server] Custom response headers, if function is passed, must return Object\n * @param config.throttle       {Number}  - [Server] DEPRECATED bps throttle threshold\n * @param config.downloadRoute  {String}  - [Both]   Server Route used to retrieve files\n * @param config.collection     {Mongo.Collection} - [Both] Mongo Collection Instance\n * @param config.collectionName {String}  - [Both]   Collection name\n * @param config.namingFunction {Function}- [Both]   Function which returns `String`\n * @param config.integrityCheck {Boolean} - [Server] Check file's integrity before serving to users\n * @param config.onAfterUpload  {Function}- [Server] Called right after file is ready on FS. Use to transfer file somewhere else, or do other thing with file directly\n * @param config.onAfterRemove  {Function} - [Server] Called right after file is removed. Removed objects is passed to callback\n * @param config.continueUploadTTL {Number} - [Server] Time in seconds, during upload may be continued, default 3 hours (10800 seconds)\n * @param config.onBeforeUpload {Function}- [Both]   Function which executes on server after receiving each chunk and on client right before beginning upload. Function context is `File` - so you are able to check for extension, mime-type, size and etc.:\n *  - return `true` to continue\n *  - return `false` or `String` to abort upload\n * @param config.getUser        {Function} - [Server] Replace default way of recognizing user, usefull when you want to auth user based on custom cookie (or other way). arguments {http: {request: {...}, response: {...}}}, need to return {userId: String, user: Function}\n * @param config.onInitiateUpload {Function} - [Server] Function which executes on server right before upload is begin and right after `onBeforeUpload` hook. This hook is fully asynchronous.\n * @param config.onBeforeRemove {Function} - [Server] Executes before removing file on server, so you can check permissions. Return `true` to allow action and `false` to deny.\n * @param config.allowClientCode  {Boolean}  - [Both]   Allow to run `remove` from client\n * @param config.downloadCallback {Function} - [Server] Callback triggered each time file is requested, return truthy value to continue download, or falsy to abort\n  * @param config.interceptRequest {Function} - [Server] Intercept incoming HTTP request, so you can whatever you want, no checks or preprocessing, arguments {http: {request: {...}, response: {...}}, params: {...}}\n * @param config.interceptDownload {Function} - [Server] Intercept download request, so you can serve file from third-party resource, arguments {http: {request: {...}, response: {...}}, fileRef: {...}}\n * @param config.disableUpload {Boolean} - Disable file upload, useful for server only solutions\n * @param config.disableDownload {Boolean} - Disable file download (serving), useful for file management only solutions\n * @param config.allowedOrigins  {Regex|Boolean}  - [Server]   Regex of Origins that are allowed CORS access or `false` to disable completely. Defaults to `/^http:\\/\\/localhost:12[0-9]{3}$/` for allowing Meteor-Cordova builds access\n * @param config.allowQueryStringCookies {Boolean} - Allow passing Cookies in a query string (in URL). Primary should be used only in Cordova environment. Note: this option will be used only on Cordova. Default: `false`\n * @param config.sanitize {Function} - Override default sanitize function\n * @param config._preCollection  {Mongo.Collection} - [Server] Mongo preCollection Instance\n * @param config._preCollectionName {String}  - [Server]  preCollection name\n * @summary Create new instance of FilesCollection\n */\nclass FilesCollection extends FilesCollectionCore {\n  constructor(config) {\n    super();\n    let storagePath;\n    if (config) {\n      ({\n        _preCollection: this._preCollection,\n        _preCollectionName: this._preCollectionName,\n        allowClientCode: this.allowClientCode,\n        allowedOrigins: this.allowedOrigins,\n        allowQueryStringCookies: this.allowQueryStringCookies,\n        cacheControl: this.cacheControl,\n        chunkSize: this.chunkSize,\n        collection: this.collection,\n        collectionName: this.collectionName,\n        continueUploadTTL: this.continueUploadTTL,\n        debug: this.debug,\n        disableDownload: this.disableDownload,\n        disableUpload: this.disableUpload,\n        downloadCallback: this.downloadCallback,\n        downloadRoute: this.downloadRoute,\n        getUser: this.getUser,\n        integrityCheck: this.integrityCheck,\n        interceptDownload: this.interceptDownload,\n        interceptRequest: this.interceptRequest,\n        namingFunction: this.namingFunction,\n        onAfterRemove: this.onAfterRemove,\n        onAfterUpload: this.onAfterUpload,\n        onBeforeRemove: this.onBeforeRemove,\n        onBeforeUpload: this.onBeforeUpload,\n        onInitiateUpload: this.onInitiateUpload,\n        parentDirPermissions: this.parentDirPermissions,\n        permissions: this.permissions,\n        protected: this.protected,\n        public: this.public,\n        responseHeaders: this.responseHeaders,\n        sanitize: this.sanitize,\n        schema: this.schema,\n        storagePath,\n        strict: this.strict,\n      } = config);\n    }\n\n    const self = this;\n\n    if (!helpers.isBoolean(this.debug)) {\n      this.debug = false;\n    }\n\n    if (!helpers.isBoolean(this.public)) {\n      this.public = false;\n    }\n\n    if (!this.protected) {\n      this.protected = false;\n    }\n\n    if (!this.chunkSize) {\n      this.chunkSize = 1024 * 512;\n    }\n\n    this.chunkSize = Math.floor(this.chunkSize / 8) * 8;\n\n    if (!helpers.isString(this.collectionName) && !this.collection) {\n      this.collectionName = 'MeteorUploadFiles';\n    }\n\n    if (!this.collection) {\n      this.collection = new Mongo.Collection(this.collectionName);\n    } else {\n      this.collectionName = this.collection._name;\n    }\n\n    this.collection.filesCollection = this;\n    check(this.collectionName, String);\n\n    if (this.public && !this.downloadRoute) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: \"downloadRoute\" must be precisely provided on \"public\" collections! Note: \"downloadRoute\" must be equal or be inside of your web/proxy-server (relative) root.`);\n    }\n\n    if (!helpers.isString(this.downloadRoute)) {\n      this.downloadRoute = '/cdn/storage';\n    }\n\n    this.downloadRoute = this.downloadRoute.replace(/\\/$/, '');\n\n    if (!helpers.isFunction(this.namingFunction)) {\n      this.namingFunction = false;\n    }\n\n    if (!helpers.isFunction(this.onBeforeUpload)) {\n      this.onBeforeUpload = false;\n    }\n\n    if (!helpers.isFunction(this.getUser)) {\n      this.getUser = false;\n    }\n\n    if (!helpers.isBoolean(this.allowClientCode)) {\n      this.allowClientCode = true;\n    }\n\n    if (!helpers.isFunction(this.onInitiateUpload)) {\n      this.onInitiateUpload = false;\n    }\n\n    if (!helpers.isFunction(this.interceptRequest)) {\n      this.interceptRequest = false;\n    }\n\n    if (!helpers.isFunction(this.interceptDownload)) {\n      this.interceptDownload = false;\n    }\n\n    if (!helpers.isBoolean(this.strict)) {\n      this.strict = true;\n    }\n\n    if (!helpers.isBoolean(this.allowQueryStringCookies)) {\n      this.allowQueryStringCookies = false;\n    }\n\n    if (!helpers.isNumber(this.permissions)) {\n      this.permissions = parseInt('644', 8);\n    }\n\n    if (!helpers.isNumber(this.parentDirPermissions)) {\n      this.parentDirPermissions = parseInt('755', 8);\n    }\n\n    if (!helpers.isString(this.cacheControl)) {\n      this.cacheControl = 'public, max-age=31536000, s-maxage=31536000';\n    }\n\n    if (!helpers.isFunction(this.onAfterUpload)) {\n      this.onAfterUpload = false;\n    }\n\n    if (!helpers.isBoolean(this.disableUpload)) {\n      this.disableUpload = false;\n    }\n\n    if (!helpers.isFunction(this.onAfterRemove)) {\n      this.onAfterRemove = false;\n    }\n\n    if (!helpers.isFunction(this.onBeforeRemove)) {\n      this.onBeforeRemove = false;\n    }\n\n    if (!helpers.isBoolean(this.integrityCheck)) {\n      this.integrityCheck = true;\n    }\n\n    if (!helpers.isBoolean(this.disableDownload)) {\n      this.disableDownload = false;\n    }\n\n    if (this.allowedOrigins === true || this.allowedOrigins === void 0) {\n      this.allowedOrigins = /^http:\\/\\/localhost:12[0-9]{3}$/;\n    }\n\n    if (!helpers.isObject(this._currentUploads)) {\n      this._currentUploads = {};\n    }\n\n    if (!helpers.isFunction(this.downloadCallback)) {\n      this.downloadCallback = false;\n    }\n\n    if (!helpers.isNumber(this.continueUploadTTL)) {\n      this.continueUploadTTL = 10800;\n    }\n\n    if (!helpers.isFunction(this.sanitize)) {\n      this.sanitize = helpers.sanitize;\n    }\n\n    if (!helpers.isFunction(this.responseHeaders)) {\n      this.responseHeaders = (responseCode, fileRef, versionRef) => {\n        const headers = {};\n        switch (responseCode) {\n        case '206':\n          headers.Pragma = 'private';\n          headers['Transfer-Encoding'] = 'chunked';\n          break;\n        case '400':\n          headers['Cache-Control'] = 'no-cache';\n          break;\n        case '416':\n          headers['Content-Range'] = `bytes */${versionRef.size}`;\n          break;\n        default:\n          break;\n        }\n\n        headers.Connection = 'keep-alive';\n        headers['Content-Type'] = versionRef.type || 'application/octet-stream';\n        headers['Accept-Ranges'] = 'bytes';\n        return headers;\n      };\n    }\n\n    if (this.public && !storagePath) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}] \"storagePath\" must be set on \"public\" collections! Note: \"storagePath\" must be equal on be inside of your web/proxy-server (absolute) root.`);\n    }\n\n    if (!storagePath) {\n      storagePath = function () {\n        return `assets${nodePath.sep}app${nodePath.sep}uploads${nodePath.sep}${self.collectionName}`;\n      };\n    }\n\n    if (helpers.isString(storagePath)) {\n      this.storagePath = () => storagePath;\n    } else {\n      this.storagePath = function () {\n        let sp = storagePath.apply(self, arguments);\n        if (!helpers.isString(sp)) {\n          throw new Meteor.Error(400, `[FilesCollection.${self.collectionName}] \"storagePath\" function must return a String!`);\n        }\n        sp = sp.replace(/\\/$/, '');\n        return nodePath.normalize(sp);\n      };\n    }\n\n    this._debug('[FilesCollection.storagePath] Set to:', this.storagePath({}));\n\n    try {\n      fs.mkdirSync(this.storagePath({}), {\n        mode: this.parentDirPermissions,\n        recursive: true\n      });\n    } catch (error) {\n      if (error) {\n        throw new Meteor.Error(401, `[FilesCollection.${self.collectionName}] Path \"${this.storagePath({})}\" is not writable!`, error);\n      }\n    }\n\n    check(this.strict, Boolean);\n    check(this.permissions, Number);\n    check(this.storagePath, Function);\n    check(this.cacheControl, String);\n    check(this.onAfterRemove, Match.OneOf(false, Function));\n    check(this.onAfterUpload, Match.OneOf(false, Function));\n    check(this.disableUpload, Boolean);\n    check(this.integrityCheck, Boolean);\n    check(this.onBeforeRemove, Match.OneOf(false, Function));\n    check(this.disableDownload, Boolean);\n    check(this.downloadCallback, Match.OneOf(false, Function));\n    check(this.interceptRequest, Match.OneOf(false, Function));\n    check(this.interceptDownload, Match.OneOf(false, Function));\n    check(this.continueUploadTTL, Number);\n    check(this.responseHeaders, Match.OneOf(Object, Function));\n    check(this.allowedOrigins, Match.OneOf(Boolean, RegExp));\n    check(this.allowQueryStringCookies, Boolean);\n\n    this._cookies = new Cookies({\n      allowQueryStringCookies: this.allowQueryStringCookies,\n      allowedCordovaOrigins: this.allowedOrigins\n    });\n\n    if (!this.disableUpload) {\n      if (!helpers.isString(this._preCollectionName) && !this._preCollection) {\n        this._preCollectionName = `__pre_${this.collectionName}`;\n      }\n\n      if (!this._preCollection) {\n        this._preCollection = new Mongo.Collection(this._preCollectionName);\n      } else {\n        this._preCollectionName = this._preCollection._name;\n      }\n      check(this._preCollectionName, String);\n\n      createIndex(this._preCollection, { createdAt: 1 }, { expireAfterSeconds: this.continueUploadTTL, background: true });\n      const _preCollectionCursor = this._preCollection.find({}, {\n        fields: {\n          _id: 1,\n          isFinished: 1\n        }\n      });\n\n      _preCollectionCursor.observe({\n        changed(doc) {\n          if (doc.isFinished) {\n            self._debug(`[FilesCollection] [_preCollectionCursor.observe] [changed]: ${doc._id}`);\n            self._preCollection.remove({_id: doc._id}, noop);\n          }\n        },\n        removed(doc) {\n          // Free memory after upload is done\n          // Or if upload is unfinished\n          self._debug(`[FilesCollection] [_preCollectionCursor.observe] [removed]: ${doc._id}`);\n          if (helpers.isObject(self._currentUploads[doc._id])) {\n            self._currentUploads[doc._id].stop();\n            self._currentUploads[doc._id].end();\n\n            // We can be unlucky to run into a race condition where another server removed this document before the change of `isFinished` is registered on this server.\n            // Therefore it's better to double-check with the main collection if the file is referenced there. Issue: https://github.com/veliovgroup/Meteor-Files/issues/672\n            if (!doc.isFinished && self.collection.find({ _id: doc._id }).count() === 0) {\n              self._debug(`[FilesCollection] [_preCollectionCursor.observe] [removeUnfinishedUpload]: ${doc._id}`);\n              self._currentUploads[doc._id].abort();\n            }\n\n            delete self._currentUploads[doc._id];\n          }\n        }\n      });\n\n      this._createStream = (_id, path, opts) => {\n        this._currentUploads[_id] = new WriteStream(path, opts.fileLength, opts, this.permissions);\n      };\n\n      // This little function allows to continue upload\n      // even after server is restarted (*not on dev-stage*)\n      this._continueUpload = (_id) => {\n        if (this._currentUploads[_id] && this._currentUploads[_id].file) {\n          if (!this._currentUploads[_id].aborted && !this._currentUploads[_id].ended) {\n            return this._currentUploads[_id].file;\n          }\n          this._createStream(_id, this._currentUploads[_id].file.file.path, this._currentUploads[_id].file);\n          return this._currentUploads[_id].file;\n        }\n        const contUpld = this._preCollection.findOne({_id});\n        if (contUpld) {\n          this._createStream(_id, contUpld.file.path, contUpld);\n          return this._currentUploads[_id].file;\n        }\n        return false;\n      };\n    }\n\n    if (!this.schema) {\n      this.schema = FilesCollectionCore.schema;\n    }\n\n    check(this.debug, Boolean);\n    check(this.schema, Object);\n    check(this.public, Boolean);\n    check(this.getUser, Match.OneOf(false, Function));\n    check(this.protected, Match.OneOf(Boolean, Function));\n    check(this.chunkSize, Number);\n    check(this.downloadRoute, String);\n    check(this.namingFunction, Match.OneOf(false, Function));\n    check(this.onBeforeUpload, Match.OneOf(false, Function));\n    check(this.onInitiateUpload, Match.OneOf(false, Function));\n    check(this.allowClientCode, Boolean);\n\n    if (this.public && this.protected) {\n      throw new Meteor.Error(500, `[FilesCollection.${this.collectionName}]: Files can not be public and protected at the same time!`);\n    }\n\n    this._checkAccess = (http) => {\n      if (this.protected) {\n        let result;\n        const {user, userId} = this._getUser(http);\n\n        if (helpers.isFunction(this.protected)) {\n          let fileRef;\n          if (helpers.isObject(http.params) &&  http.params._id) {\n            fileRef = this.collection.findOne(http.params._id);\n          }\n\n          result = http ? this.protected.call(Object.assign(http, {user, userId}), (fileRef || null)) : this.protected.call({user, userId}, (fileRef || null));\n        } else {\n          result = !!userId;\n        }\n\n        if ((http && (result === true)) || !http) {\n          return true;\n        }\n\n        const rc = helpers.isNumber(result) ? result : 401;\n        this._debug('[FilesCollection._checkAccess] WARN: Access denied!');\n        if (http) {\n          const text = 'Access denied!';\n          if (!http.response.headersSent) {\n            http.response.writeHead(rc, {\n              'Content-Type': 'text/plain',\n              'Content-Length': text.length\n            });\n          }\n\n          if (!http.response.finished) {\n            http.response.end(text);\n          }\n        }\n\n        return false;\n      }\n      return true;\n    };\n\n    this._methodNames = {\n      _Abort: `_FilesCollectionAbort_${this.collectionName}`,\n      _Write: `_FilesCollectionWrite_${this.collectionName}`,\n      _Start: `_FilesCollectionStart_${this.collectionName}`,\n      _Remove: `_FilesCollectionRemove_${this.collectionName}`\n    };\n\n    this.on('_handleUpload', this._handleUpload);\n    this.on('_finishUpload', this._finishUpload);\n    this._handleUploadSync = Meteor.wrapAsync(this._handleUpload.bind(this));\n\n    if (this.disableUpload && this.disableDownload) {\n      return;\n    }\n    WebApp.connectHandlers.use((httpReq, httpResp, next) => {\n      if (this.allowedOrigins && httpReq._parsedUrl.path.includes(`${this.downloadRoute}/`) && !httpResp.headersSent) {\n        if (this.allowedOrigins.test(httpReq.headers.origin)) {\n          httpResp.setHeader('Access-Control-Allow-Credentials', 'true');\n          httpResp.setHeader('Access-Control-Allow-Origin', httpReq.headers.origin);\n        }\n\n        if (httpReq.method === 'OPTIONS') {\n          httpResp.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');\n          httpResp.setHeader('Access-Control-Allow-Headers', 'Range, Content-Type, x-mtok, x-start, x-chunkid, x-fileid, x-eof');\n          httpResp.setHeader('Access-Control-Expose-Headers', 'Accept-Ranges, Content-Encoding, Content-Length, Content-Range');\n          httpResp.setHeader('Allow', 'GET, POST, OPTIONS');\n          httpResp.writeHead(200);\n          httpResp.end();\n          return;\n        }\n      }\n\n      if (!this.disableUpload && httpReq._parsedUrl.path.includes(`${this.downloadRoute}/${this.collectionName}/__upload`)) {\n        if (httpReq.method !== 'POST') {\n          next();\n          return;\n        }\n\n        const handleError = (_error) => {\n          let error = _error;\n          Meteor._debug('[FilesCollection] [Upload] [HTTP] Exception:', error);\n\n          if (!httpResp.headersSent) {\n            httpResp.writeHead(500);\n          }\n\n          if (!httpResp.finished) {\n            if (helpers.isObject(error) && helpers.isFunction(error.toString)) {\n              error = error.toString();\n            }\n\n            if (!helpers.isString(error)) {\n              error = 'Unexpected error!';\n            }\n\n            httpResp.end(JSON.stringify({ error }));\n          }\n        };\n\n        let body = '';\n        const handleData = () => {\n          try {\n            let opts;\n            let result;\n            let user = this._getUser({request: httpReq, response: httpResp});\n\n            if (httpReq.headers['x-start'] !== '1') {\n              // CHUNK UPLOAD SCENARIO:\n              opts = {\n                fileId: this.sanitize(httpReq.headers['x-fileid'], 20, 'a')\n              };\n\n              if (httpReq.headers['x-eof'] === '1') {\n                opts.eof = true;\n              } else {\n                opts.binData = Buffer.from(body, 'base64');\n                opts.chunkId = parseInt(httpReq.headers['x-chunkid']);\n              }\n\n              const _continueUpload = this._continueUpload(opts.fileId);\n              if (!_continueUpload) {\n                throw new Meteor.Error(408, 'Can\\'t continue upload, session expired. Start upload again.');\n              }\n\n              ({result, opts} = this._prepareUpload(Object.assign(opts, _continueUpload), user.userId, 'HTTP'));\n\n              if (opts.eof) {\n                // FINISH UPLOAD SCENARIO:\n                this._handleUpload(result, opts, (_error) => {\n                  let error = _error;\n                  if (error) {\n                    if (!httpResp.headersSent) {\n                      httpResp.writeHead(500);\n                    }\n\n                    if (!httpResp.finished) {\n                      if (helpers.isObject(error) && helpers.isFunction(error.toString)) {\n                        error = error.toString();\n                      }\n\n                      if (!helpers.isString(error)) {\n                        error = 'Unexpected error!';\n                      }\n\n                      httpResp.end(JSON.stringify({ error }));\n                    }\n                  }\n\n                  if (!httpResp.headersSent) {\n                    httpResp.writeHead(200);\n                  }\n\n                  if (helpers.isObject(result.file) && result.file.meta) {\n                    result.file.meta = fixJSONStringify(result.file.meta);\n                  }\n\n                  if (!httpResp.finished) {\n                    httpResp.end(JSON.stringify(result));\n                  }\n                });\n                return;\n              }\n\n              this.emit('_handleUpload', result, opts, noop);\n\n              if (!httpResp.headersSent) {\n                httpResp.writeHead(204);\n              }\n              if (!httpResp.finished) {\n                httpResp.end();\n              }\n            } else {\n              // START SCENARIO:\n              try {\n                opts = JSON.parse(body);\n              } catch (jsonErr) {\n                Meteor._debug('Can\\'t parse incoming JSON from Client on [.insert() | upload], something went wrong!', jsonErr);\n                opts = {file: {}};\n              }\n\n              if (!helpers.isObject(opts.file)) {\n                opts.file = {};\n              }\n\n              if (opts.fileId) {\n                opts.fileId = this.sanitize(opts.fileId, 20, 'a');\n              }\n\n              this._debug(`[FilesCollection] [File Start HTTP] ${opts.file.name || '[no-name]'} - ${opts.fileId}`);\n              if (helpers.isObject(opts.file) && opts.file.meta) {\n                opts.file.meta = fixJSONParse(opts.file.meta);\n              }\n\n              opts.___s = true;\n              ({result} = this._prepareUpload(helpers.clone(opts), user.userId, 'HTTP Start Method'));\n\n              if (this.collection.findOne(result._id)) {\n                throw new Meteor.Error(400, 'Can\\'t start upload, data substitution detected!');\n              }\n\n              opts._id = opts.fileId;\n              opts.createdAt = new Date();\n              opts.maxLength = opts.fileLength;\n              this._preCollection.insert(helpers.omit(opts, '___s'));\n              this._createStream(result._id, result.path, helpers.omit(opts, '___s'));\n\n              if (opts.returnMeta) {\n                if (!httpResp.headersSent) {\n                  httpResp.writeHead(200);\n                }\n\n                if (!httpResp.finished) {\n                  httpResp.end(JSON.stringify({\n                    uploadRoute: `${this.downloadRoute}/${this.collectionName}/__upload`,\n                    file: result\n                  }));\n                }\n              } else {\n                if (!httpResp.headersSent) {\n                  httpResp.writeHead(204);\n                }\n\n                if (!httpResp.finished) {\n                  httpResp.end();\n                }\n              }\n            }\n          } catch (httpRespErr) {\n            handleError(httpRespErr);\n          }\n        };\n\n        httpReq.setTimeout(20000, handleError);\n        if (typeof httpReq.body === 'object' && Object.keys(httpReq.body).length !== 0) {\n          body = JSON.stringify(httpReq.body);\n          handleData();\n        } else {\n          httpReq.on('data', (data) => bound(() => {\n            body += data;\n          }));\n\n          httpReq.on('end', () => bound(() => {\n            handleData();\n          }));\n        }\n        return;\n      }\n\n      if (!this.disableDownload) {\n        let uri;\n\n        if (!this.public) {\n          if (httpReq._parsedUrl.path.includes(`${this.downloadRoute}/${this.collectionName}`)) {\n            uri = httpReq._parsedUrl.path.replace(`${this.downloadRoute}/${this.collectionName}`, '');\n            if (uri.indexOf('/') === 0) {\n              uri = uri.substring(1);\n            }\n\n            const uris = uri.split('/');\n            if (uris.length === 3) {\n              const params = {\n                _id: uris[0],\n                query: httpReq._parsedUrl.query ? nodeQs.parse(httpReq._parsedUrl.query) : {},\n                name: uris[2].split('?')[0],\n                version: uris[1]\n              };\n\n              const http = {request: httpReq, response: httpResp, params};\n              if (this.interceptRequest && helpers.isFunction(this.interceptRequest) && this.interceptRequest(http) === true) {\n                return;\n              }\n\n              if (this._checkAccess(http)) {\n                this.download(http, uris[1], this.collection.findOne(uris[0]));\n              }\n            } else {\n              next();\n            }\n          } else {\n            next();\n          }\n        } else {\n          if (httpReq._parsedUrl.path.includes(`${this.downloadRoute}`)) {\n            uri = httpReq._parsedUrl.path.replace(`${this.downloadRoute}`, '');\n            if (uri.indexOf('/') === 0) {\n              uri = uri.substring(1);\n            }\n\n            const uris = uri.split('/');\n            let _file = uris[uris.length - 1];\n            if (_file) {\n              let version;\n              if (_file.includes('-')) {\n                version = _file.split('-')[0];\n                _file = _file.split('-')[1].split('?')[0];\n              } else {\n                version = 'original';\n                _file = _file.split('?')[0];\n              }\n\n              const params = {\n                query: httpReq._parsedUrl.query ? nodeQs.parse(httpReq._parsedUrl.query) : {},\n                file: _file,\n                _id: _file.split('.')[0],\n                version,\n                name: _file\n              };\n              const http = {request: httpReq, response: httpResp, params};\n              if (this.interceptRequest && helpers.isFunction(this.interceptRequest) && this.interceptRequest(http) === true) {\n                return;\n              }\n              this.download(http, version, this.collection.findOne(params._id));\n            } else {\n              next();\n            }\n          } else {\n            next();\n          }\n        }\n        return;\n      }\n      next();\n    });\n\n    if (!this.disableUpload) {\n      const _methods = {};\n\n      // Method used to remove file\n      // from Client side\n      _methods[this._methodNames._Remove] = function (selector) {\n        check(selector, Match.OneOf(String, Object));\n        self._debug(`[FilesCollection] [Unlink Method] [.remove(${selector})]`);\n\n        if (self.allowClientCode) {\n          if (self.onBeforeRemove && helpers.isFunction(self.onBeforeRemove)) {\n            const userId = this.userId;\n            const userFuncs = {\n              userId: this.userId,\n              user() {\n                if (Meteor.users) {\n                  return Meteor.users.findOne(userId);\n                }\n                return null;\n              }\n            };\n\n            if (!self.onBeforeRemove.call(userFuncs, (self.find(selector) || null))) {\n              throw new Meteor.Error(403, '[FilesCollection] [remove] Not permitted!');\n            }\n          }\n\n          const cursor = self.find(selector);\n          if (cursor.count() > 0) {\n            self.remove(selector);\n            return true;\n          }\n          throw new Meteor.Error(404, 'Cursor is empty, no files is removed');\n        } else {\n          throw new Meteor.Error(405, '[FilesCollection] [remove] Running code on a client is not allowed!');\n        }\n      };\n\n\n      // Method used to receive \"first byte\" of upload\n      // and all file's meta-data, so\n      // it won't be transferred with every chunk\n      // Basically it prepares everything\n      // So user can pause/disconnect and\n      // continue upload later, during `continueUploadTTL`\n      _methods[this._methodNames._Start] = function (opts, returnMeta) {\n        check(opts, {\n          file: Object,\n          fileId: String,\n          FSName: Match.Optional(String),\n          chunkSize: Number,\n          fileLength: Number\n        });\n\n        check(returnMeta, Match.Optional(Boolean));\n\n        opts.fileId = self.sanitize(opts.fileId, 20, 'a');\n\n        self._debug(`[FilesCollection] [File Start Method] ${opts.file.name} - ${opts.fileId}`);\n        opts.___s = true;\n        const { result } = self._prepareUpload(helpers.clone(opts), this.userId, 'DDP Start Method');\n\n        if (self.collection.findOne(result._id)) {\n          throw new Meteor.Error(400, 'Can\\'t start upload, data substitution detected!');\n        }\n\n        opts._id = opts.fileId;\n        opts.createdAt = new Date();\n        opts.maxLength = opts.fileLength;\n        try {\n          self._preCollection.insert(helpers.omit(opts, '___s'));\n          self._createStream(result._id, result.path, helpers.omit(opts, '___s'));\n        } catch (e) {\n          self._debug(`[FilesCollection] [File Start Method] [EXCEPTION:] ${opts.file.name} - ${opts.fileId}`, e);\n          throw new Meteor.Error(500, 'Can\\'t start');\n        }\n\n        if (returnMeta) {\n          return {\n            uploadRoute: `${self.downloadRoute}/${self.collectionName}/__upload`,\n            file: result\n          };\n        }\n        return true;\n      };\n\n\n      // Method used to write file chunks\n      // it receives very limited amount of meta-data\n      // This method also responsible for EOF\n      _methods[this._methodNames._Write] = function (_opts) {\n        let opts = _opts;\n        let result;\n        check(opts, {\n          eof: Match.Optional(Boolean),\n          fileId: String,\n          binData: Match.Optional(String),\n          chunkId: Match.Optional(Number)\n        });\n\n        opts.fileId = self.sanitize(opts.fileId, 20, 'a');\n\n        if (opts.binData) {\n          opts.binData = Buffer.from(opts.binData, 'base64');\n        }\n\n        const _continueUpload = self._continueUpload(opts.fileId);\n        if (!_continueUpload) {\n          throw new Meteor.Error(408, 'Can\\'t continue upload, session expired. Start upload again.');\n        }\n\n        this.unblock();\n        ({result, opts} = self._prepareUpload(Object.assign(opts, _continueUpload), this.userId, 'DDP'));\n\n        if (opts.eof) {\n          try {\n            return self._handleUploadSync(result, opts);\n          } catch (handleUploadErr) {\n            self._debug('[FilesCollection] [Write Method] [DDP] Exception:', handleUploadErr);\n            throw handleUploadErr;\n          }\n        } else {\n          self.emit('_handleUpload', result, opts, noop);\n        }\n        return true;\n      };\n\n      // Method used to Abort upload\n      // - Freeing memory by ending writableStreams\n      // - Removing temporary record from @_preCollection\n      // - Removing record from @collection\n      // - .unlink()ing chunks from FS\n      _methods[this._methodNames._Abort] = function (_id) {\n        check(_id, String);\n\n        const _continueUpload = self._continueUpload(_id);\n        self._debug(`[FilesCollection] [Abort Method]: ${_id} - ${(helpers.isObject(_continueUpload.file) ? _continueUpload.file.path : '')}`);\n\n        if (self._currentUploads && self._currentUploads[_id]) {\n          self._currentUploads[_id].stop();\n          self._currentUploads[_id].abort();\n        }\n\n        if (_continueUpload) {\n          self._preCollection.remove({_id});\n          self.remove({_id});\n          if (helpers.isObject(_continueUpload.file) && _continueUpload.file.path) {\n            self.unlink({_id, path: _continueUpload.file.path});\n          }\n        }\n        return true;\n      };\n\n      Meteor.methods(_methods);\n    }\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _prepareUpload\n   * @summary Internal method. Used to optimize received data and check upload permission\n   * @returns {Object}\n   */\n  _prepareUpload(opts = {}, userId, transport) {\n    let ctx;\n    if (!helpers.isBoolean(opts.eof)) {\n      opts.eof = false;\n    }\n\n    if (!opts.binData) {\n      opts.binData = 'EOF';\n    }\n\n    if (!helpers.isNumber(opts.chunkId)) {\n      opts.chunkId = -1;\n    }\n\n    if (!helpers.isString(opts.FSName)) {\n      opts.FSName = opts.fileId;\n    }\n\n    this._debug(`[FilesCollection] [Upload] [${transport}] Got #${opts.chunkId}/${opts.fileLength} chunks, dst: ${opts.file.name || opts.file.fileName}`);\n\n    const fileName = this._getFileName(opts.file);\n    const {extension, extensionWithDot} = this._getExt(fileName);\n\n    if (!helpers.isObject(opts.file.meta)) {\n      opts.file.meta = {};\n    }\n\n    let result = opts.file;\n    result.name = fileName;\n    result.meta = opts.file.meta;\n    result.extension = extension;\n    result.ext = extension;\n    result._id = opts.fileId;\n    result.userId = userId || null;\n    opts.FSName = this.sanitize(opts.FSName);\n\n    if (this.namingFunction) {\n      opts.FSName = this.namingFunction(opts);\n    }\n\n    result.path = `${this.storagePath(result)}${nodePath.sep}${opts.FSName}${extensionWithDot}`;\n    result = Object.assign(result, this._dataToSchema(result));\n\n    if (this.onBeforeUpload && helpers.isFunction(this.onBeforeUpload)) {\n      ctx = Object.assign({\n        file: opts.file\n      }, {\n        chunkId: opts.chunkId,\n        userId: result.userId,\n        user() {\n          if (Meteor.users && result.userId) {\n            return Meteor.users.findOne(result.userId);\n          }\n          return null;\n        },\n        eof: opts.eof\n      });\n      const isUploadAllowed = this.onBeforeUpload.call(ctx, result);\n\n      if (isUploadAllowed !== true) {\n        throw new Meteor.Error(403, helpers.isString(isUploadAllowed) ? isUploadAllowed : '@onBeforeUpload() returned false');\n      } else {\n        if ((opts.___s === true) && this.onInitiateUpload && helpers.isFunction(this.onInitiateUpload)) {\n          this.onInitiateUpload.call(ctx, result);\n        }\n      }\n    } else if ((opts.___s === true) && this.onInitiateUpload && helpers.isFunction(this.onInitiateUpload)) {\n      ctx = Object.assign({\n        file: opts.file\n      }, {\n        chunkId: opts.chunkId,\n        userId: result.userId,\n        user() {\n          if (Meteor.users && result.userId) {\n            return Meteor.users.findOne(result.userId);\n          }\n          return null;\n        },\n        eof: opts.eof\n      });\n      this.onInitiateUpload.call(ctx, result);\n    }\n\n    return {result, opts};\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _finishUpload\n   * @summary Internal method. Finish upload, close Writable stream, add record to MongoDB and flush used memory\n   * @returns {undefined}\n   */\n  _finishUpload(result, opts, cb) {\n    this._debug(`[FilesCollection] [Upload] [finish(ing)Upload] -> ${result.path}`);\n    fs.chmod(result.path, this.permissions, noop);\n    result.type = this._getMimeType(opts.file);\n    result.public = this.public;\n    this._updateFileTypes(result);\n\n    this.collection.insert(helpers.clone(result), (colInsert, _id) => {\n      if (colInsert) {\n        cb && cb(colInsert);\n        this._debug('[FilesCollection] [Upload] [_finishUpload] [insert] Error:', colInsert);\n      } else {\n        this._preCollection.update({_id: opts.fileId}, {$set: {isFinished: true}}, (preUpdateError) => {\n          if (preUpdateError) {\n            cb && cb(preUpdateError);\n            this._debug('[FilesCollection] [Upload] [_finishUpload] [update] Error:', preUpdateError);\n          } else {\n            result._id = _id;\n            this._debug(`[FilesCollection] [Upload] [finish(ed)Upload] -> ${result.path}`);\n            this.onAfterUpload && this.onAfterUpload.call(this, result);\n            this.emit('afterUpload', result);\n            cb && cb(null, result);\n          }\n        });\n      }\n    });\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _handleUpload\n   * @summary Internal method to handle upload process, pipe incoming data to Writable stream\n   * @returns {undefined}\n   */\n  _handleUpload(result, opts, cb) {\n    try {\n      if (opts.eof) {\n        this._currentUploads[result._id].end(() => {\n          this.emit('_finishUpload', result, opts, cb);\n        });\n      } else {\n        this._currentUploads[result._id].write(opts.chunkId, opts.binData, cb);\n      }\n    } catch (e) {\n      this._debug('[_handleUpload] [EXCEPTION:]', e);\n      cb && cb(e);\n    }\n  }\n\n  /**\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getMimeType\n   * @param {Object} fileData - File Object\n   * @summary Returns file's mime-type\n   * @returns {String}\n   */\n  _getMimeType(fileData) {\n    let mime;\n    check(fileData, Object);\n    if (helpers.isObject(fileData) && fileData.type) {\n      mime = fileData.type;\n    }\n\n    if (!mime || !helpers.isString(mime)) {\n      mime = 'application/octet-stream';\n    }\n    return mime;\n  }\n\n  /**\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUserId\n   * @summary Returns `userId` matching the xmtok token derived from Meteor.server.sessions\n   * @returns {String}\n   */\n  _getUserId(xmtok) {\n    if (!xmtok) return null;\n\n    // throw an error upon an unexpected type of Meteor.server.sessions in order to identify breaking changes\n    if (!Meteor.server.sessions instanceof Map || !helpers.isObject(Meteor.server.sessions)) {\n      throw new Error('Received incompatible type of Meteor.server.sessions');\n    }\n\n    if (Meteor.server.sessions instanceof Map && Meteor.server.sessions.has(xmtok) && helpers.isObject(Meteor.server.sessions.get(xmtok))) {\n      // to be used with >= Meteor 1.8.1 where Meteor.server.sessions is a Map\n      return Meteor.server.sessions.get(xmtok).userId;\n    } else if (helpers.isObject(Meteor.server.sessions) && xmtok in Meteor.server.sessions && helpers.isObject(Meteor.server.sessions[xmtok])) {\n      // to be used with < Meteor 1.8.1 where Meteor.server.sessions is an Object\n      return Meteor.server.sessions[xmtok].userId;\n    }\n\n    return null;\n  }\n\n  /**\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUser\n   * @summary Returns object with `userId` and `user()` method which return user's object\n   * @returns {Object}\n   */\n  _getUser() {\n    return this.getUser ?\n      this.getUser(...arguments) : this._getUserDefault(...arguments);\n  }\n\n  /**\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name _getUserDefault\n   * @summary Default way of recognising user based on 'x_mtok' cookie, can be replaced by 'config.getUser' if defnied. Returns object with `userId` and `user()` method which return user's object\n   * @returns {Object}\n   */\n  _getUserDefault(http) {\n    const result = {\n      user() { return null; },\n      userId: null\n    };\n\n    if (http) {\n      let mtok = null;\n      if (http.request.headers['x-mtok']) {\n        mtok = http.request.headers['x-mtok'];\n      } else {\n        const cookie = http.request.Cookies;\n        if (cookie.has('x_mtok')) {\n          mtok = cookie.get('x_mtok');\n        }\n      }\n\n      if (mtok) {\n        const userId = this._getUserId(mtok);\n\n        if (userId) {\n          result.user = () => Meteor.users.findOne(userId);\n          result.userId = userId;\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name write\n   * @param {Buffer} buffer - Binary File's Buffer\n   * @param {Object} opts - Object with file-data\n   * @param {String} opts.name - File name, alias: `fileName`\n   * @param {String} opts.type - File mime-type\n   * @param {Object} opts.meta - File additional meta-data\n   * @param {String} opts.userId - UserId, default *null*\n   * @param {String} opts.fileId - _id, sanitized, max-length: 20; default *null*\n   * @param {Function} callback - function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Write buffer to FS and add to FilesCollection Collection\n   * @returns {FilesCollection} Instance\n   */\n  write(buffer, _opts = {}, _callback, _proceedAfterUpload) {\n    this._debug('[FilesCollection] [write()]');\n    let opts = _opts;\n    let callback = _callback;\n    let proceedAfterUpload = _proceedAfterUpload;\n\n    if (helpers.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts = {};\n    } else if (helpers.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (helpers.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    opts.fileId = opts.fileId && this.sanitize(opts.fileId, 20, 'a');\n    const fileId = opts.fileId || Random.id();\n    const fsName = this.namingFunction ? this.namingFunction(opts) : fileId;\n    const fileName = (opts.name || opts.fileName) ? (opts.name || opts.fileName) : fsName;\n\n    const {extension, extensionWithDot} = this._getExt(fileName);\n\n    opts.path = `${this.storagePath(opts)}${nodePath.sep}${fsName}${extensionWithDot}`;\n    opts.type = this._getMimeType(opts);\n    if (!helpers.isObject(opts.meta)) {\n      opts.meta = {};\n    }\n\n    if (!helpers.isNumber(opts.size)) {\n      opts.size = buffer.length;\n    }\n\n    const result = this._dataToSchema({\n      name: fileName,\n      path: opts.path,\n      meta: opts.meta,\n      type: opts.type,\n      size: opts.size,\n      userId: opts.userId,\n      extension\n    });\n\n    result._id = fileId;\n\n    fs.stat(opts.path, (statError, stats) => {\n      bound(() => {\n        if (statError || !stats.isFile()) {\n          const paths = opts.path.split('/');\n          paths.pop();\n          fs.mkdirSync(paths.join('/'), { recursive: true });\n          fs.writeFileSync(opts.path, '');\n        }\n\n        const stream = fs.createWriteStream(opts.path, {flags: 'w', mode: this.permissions});\n        stream.end(buffer, (streamErr) => {\n          bound(() => {\n            if (streamErr) {\n              callback && callback(streamErr);\n            } else {\n              this.collection.insert(result, (insertErr, _id) => {\n                if (insertErr) {\n                  callback && callback(insertErr);\n                  this._debug(`[FilesCollection] [write] [insert] Error: ${fileName} -> ${this.collectionName}`, insertErr);\n                } else {\n                  const fileRef = this.collection.findOne(_id);\n                  callback && callback(null, fileRef);\n                  if (proceedAfterUpload === true) {\n                    this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n                    this.emit('afterUpload', fileRef);\n                  }\n                  this._debug(`[FilesCollection] [write]: ${fileName} -> ${this.collectionName}`);\n                }\n              });\n            }\n          });\n        });\n      });\n    });\n    return this;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name load\n   * @param {String} url - URL to file\n   * @param {Object} [opts] - Object with file-data\n   * @param {Object} opts.headers - HTTP headers to use when requesting the file\n   * @param {String} opts.name - File name, alias: `fileName`\n   * @param {String} opts.type - File mime-type\n   * @param {Object} opts.meta - File additional meta-data\n   * @param {String} opts.userId - UserId, default *null*\n   * @param {String} opts.fileId - _id, sanitized, max-length: 20; default *null*\n   * @param {Number} opts.timeout - Timeout in milliseconds, default: 360000 (6 mins)\n   * @param {Function} callback - function(error, fileObj){...}\n   * @param {Boolean} [proceedAfterUpload] - Proceed onAfterUpload hook\n   * @summary Download file over HTTP, write stream to FS, and add to FilesCollection Collection\n   * @returns {FilesCollection} Instance\n   */\n  load(url, _opts = {}, _callback, _proceedAfterUpload = false) {\n    this._debug(`[FilesCollection] [load(${url}, ${JSON.stringify(_opts)}, callback)]`);\n    let opts = _opts;\n    let callback = _callback;\n    let proceedAfterUpload = _proceedAfterUpload;\n\n    if (helpers.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts = {};\n    } else if (helpers.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (helpers.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    check(url, String);\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    if (!helpers.isObject(opts)) {\n      opts = {\n        timeout: 360000\n      };\n    }\n\n    if (!opts.timeout) {\n      opts.timeout = 360000;\n    }\n\n    const fileId = (opts.fileId && this.sanitize(opts.fileId, 20, 'a')) || Random.id();\n    const fsName = this.namingFunction ? this.namingFunction(opts) : fileId;\n    const pathParts = url.split('/');\n    const fileName = (opts.name || opts.fileName) ? (opts.name || opts.fileName) : pathParts[pathParts.length - 1].split('?')[0] || fsName;\n\n    const {extension, extensionWithDot} = this._getExt(fileName);\n    opts.path = `${this.storagePath(opts)}${nodePath.sep}${fsName}${extensionWithDot}`;\n\n    const storeResult = (result, cb) => {\n      result._id = fileId;\n\n      this.collection.insert(result, (error, _id) => {\n        if (error) {\n          cb && cb(error);\n          this._debug(`[FilesCollection] [load] [insert] Error: ${fileName} -> ${this.collectionName}`, error);\n        } else {\n          const fileRef = this.collection.findOne(_id);\n          cb && cb(null, fileRef);\n          if (proceedAfterUpload === true) {\n            this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n            this.emit('afterUpload', fileRef);\n          }\n          this._debug(`[FilesCollection] [load] [insert] ${fileName} -> ${this.collectionName}`);\n        }\n      });\n    };\n\n    fs.stat(opts.path, (statError, stats) => {\n      bound(() => {\n        if (statError || !stats.isFile()) {\n          const paths = opts.path.split('/');\n          paths.pop();\n          fs.mkdirSync(paths.join('/'), { recursive: true });\n          fs.writeFileSync(opts.path, '');\n        }\n\n        let isEnded = false;\n        let timer = null;\n        const wStream = fs.createWriteStream(opts.path, {flags: 'w', mode: this.permissions, autoClose: true, emitClose: false });\n        const onEnd = (_error, response) => {\n          if (!isEnded) {\n            if (timer) {\n              Meteor.clearTimeout(timer);\n              timer = null;\n            }\n\n            isEnded = true;\n            if (response && response.status === 200) {\n              this._debug(`[FilesCollection] [load] Received: ${url}`);\n              const result = this._dataToSchema({\n                name: fileName,\n                path: opts.path,\n                meta: opts.meta,\n                type: opts.type || response.headers.get('content-type') || this._getMimeType({path: opts.path}),\n                size: opts.size || parseInt(response.headers.get('content-length') || 0),\n                userId: opts.userId,\n                extension\n              });\n\n              if (!result.size) {\n                fs.stat(opts.path, (statErrorOnEnd, newStats) => {\n                  bound(() => {\n                    if (statErrorOnEnd) {\n                      callback && callback(statErrorOnEnd);\n                    } else {\n                      result.versions.original.size = (result.size = newStats.size);\n                      storeResult(result, callback);\n                    }\n                  });\n                });\n              } else {\n                storeResult(result, callback);\n              }\n            } else {\n              const error = _error || new Meteor.Error(response?.status || 408, response?.statusText || 'Bad response with empty details');\n              this._debug(`[FilesCollection] [load] [fetch(${url})] Error:`, error);\n\n              if (!wStream.destroyed) {\n                wStream.destroy();\n              }\n\n              fs.unlink(opts.path, (unlinkError) => {\n                bound(() => {\n                  callback && callback(error);\n                  if (unlinkError) {\n                    this._debug(`[FilesCollection] [load] [fetch(${url})] [fs.unlink(${opts.path})] unlinkError:`, unlinkError);\n                  }\n                });\n              });\n            }\n          }\n        };\n\n        let resp = void 0;\n        wStream.on('error', (error) => {\n          bound(() => {\n            onEnd(error);\n          });\n        });\n        wStream.on('close', () => {\n          bound(() => {\n            onEnd(void 0, resp);\n          });\n        });\n        wStream.on('finish', () => {\n          bound(() => {\n            onEnd(void 0, resp);\n          });\n        });\n\n        const controller = new AbortController();\n        fetch(url, {\n          headers: opts.headers || {},\n          signal: controller.signal\n        }).then((res) => {\n          resp = res;\n          res.body.on('error', (error) => {\n            bound(() => {\n              onEnd(error);\n            });\n          });\n          res.body.pipe(wStream);\n        }).catch((fetchError) => {\n          onEnd(fetchError);\n        });\n\n        if (opts.timeout > 0) {\n          timer = Meteor.setTimeout(() => {\n            onEnd(new Meteor.Error(408, `Request timeout after ${opts.timeout}ms`));\n            controller.abort();\n          }, opts.timeout);\n        }\n      });\n    });\n\n    return this;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name addFile\n   * @param {String} path          - Path to file\n   * @param {String} opts          - [Optional] Object with file-data\n   * @param {String} opts.type     - [Optional] File mime-type\n   * @param {Object} opts.meta     - [Optional] File additional meta-data\n   * @param {String} opts.fileId   - _id, sanitized, max-length: 20 symbols default *null*\n   * @param {Object} opts.fileName - [Optional] File name, if not specified file name and extension will be taken from path\n   * @param {String} opts.userId   - [Optional] UserId, default *null*\n   * @param {Function} callback    - [Optional] function(error, fileObj){...}\n   * @param {Boolean} proceedAfterUpload - Proceed onAfterUpload hook\n   * @summary Add file from FS to FilesCollection\n   * @returns {FilesCollection} Instance\n   */\n  addFile(path, _opts = {}, _callback, _proceedAfterUpload) {\n    this._debug(`[FilesCollection] [addFile(${path})]`);\n    let opts = _opts;\n    let callback = _callback;\n    let proceedAfterUpload = _proceedAfterUpload;\n\n    if (helpers.isFunction(opts)) {\n      proceedAfterUpload = callback;\n      callback = opts;\n      opts = {};\n    } else if (helpers.isBoolean(callback)) {\n      proceedAfterUpload = callback;\n    } else if (helpers.isBoolean(opts)) {\n      proceedAfterUpload = opts;\n    }\n\n    if (this.public) {\n      throw new Meteor.Error(403, 'Can not run [addFile] on public collection! Just Move file to root of your server, then add record to Collection');\n    }\n\n    check(path, String);\n    check(opts, Match.Optional(Object));\n    check(callback, Match.Optional(Function));\n    check(proceedAfterUpload, Match.Optional(Boolean));\n\n    fs.stat(path, (statErr, stats) => bound(() => {\n      if (statErr) {\n        callback && callback(statErr);\n      } else if (stats.isFile()) {\n        if (!helpers.isObject(opts)) {\n          opts = {};\n        }\n        opts.path = path;\n\n        if (!opts.fileName) {\n          const pathParts = path.split(nodePath.sep);\n          opts.fileName = path.split(nodePath.sep)[pathParts.length - 1];\n        }\n\n        const {extension} = this._getExt(opts.fileName);\n\n        if (!helpers.isString(opts.type)) {\n          opts.type = this._getMimeType(opts);\n        }\n\n        if (!helpers.isObject(opts.meta)) {\n          opts.meta = {};\n        }\n\n        if (!helpers.isNumber(opts.size)) {\n          opts.size = stats.size;\n        }\n\n        const result = this._dataToSchema({\n          name: opts.fileName,\n          path,\n          meta: opts.meta,\n          type: opts.type,\n          size: opts.size,\n          userId: opts.userId,\n          extension,\n          _storagePath: path.replace(`${nodePath.sep}${opts.fileName}`, ''),\n          fileId: (opts.fileId && this.sanitize(opts.fileId, 20, 'a')) || null\n        });\n\n\n        this.collection.insert(result, (insertErr, _id) => {\n          if (insertErr) {\n            callback && callback(insertErr);\n            this._debug(`[FilesCollection] [addFile] [insert] Error: ${result.name} -> ${this.collectionName}`, insertErr);\n          } else {\n            const fileRef = this.collection.findOne(_id);\n            callback && callback(null, fileRef);\n            if (proceedAfterUpload === true) {\n              this.onAfterUpload && this.onAfterUpload.call(this, fileRef);\n              this.emit('afterUpload', fileRef);\n            }\n            this._debug(`[FilesCollection] [addFile]: ${result.name} -> ${this.collectionName}`);\n          }\n        });\n      } else {\n        callback && callback(new Meteor.Error(400, `[FilesCollection] [addFile(${path})]: File does not exist`));\n      }\n    }));\n    return this;\n  }\n\n  /**\n   * @locus Anywhere\n   * @memberOf FilesCollection\n   * @name remove\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Function} callback - Callback with one `error` argument\n   * @summary Remove documents from the collection\n   * @returns {FilesCollection} Instance\n   */\n  remove(selector, callback) {\n    this._debug(`[FilesCollection] [remove(${JSON.stringify(selector)})]`);\n    if (selector === void 0) {\n      return 0;\n    }\n    check(callback, Match.Optional(Function));\n\n    const files = this.collection.find(selector);\n    if (files.count() > 0) {\n      files.forEach((file) => {\n        this.unlink(file);\n      });\n    } else {\n      callback && callback(new Meteor.Error(404, 'Cursor is empty, no files is removed'));\n      return this;\n    }\n\n    if (this.onAfterRemove) {\n      const docs = files.fetch();\n      const self = this;\n      this.collection.remove(selector, function () {\n        callback && callback.apply(this, arguments);\n        self.onAfterRemove(docs);\n      });\n    } else {\n      this.collection.remove(selector, (callback || noop));\n    }\n    return this;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name deny\n   * @param {Object} rules\n   * @see  https://docs.meteor.com/api/collections.html#Mongo-Collection-deny\n   * @summary link Mongo.Collection deny methods\n   * @returns {Mongo.Collection} Instance\n   */\n  deny(rules) {\n    this.collection.deny(rules);\n    return this.collection;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name allow\n   * @param {Object} rules\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-allow\n   * @summary link Mongo.Collection allow methods\n   * @returns {Mongo.Collection} Instance\n   */\n  allow(rules) {\n    this.collection.allow(rules);\n    return this.collection;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name denyClient\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-deny\n   * @summary Shorthands for Mongo.Collection deny method\n   * @returns {Mongo.Collection} Instance\n   */\n  denyClient() {\n    this.collection.deny({\n      insert() { return true; },\n      update() { return true; },\n      remove() { return true; }\n    });\n    return this.collection;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name allowClient\n   * @see https://docs.meteor.com/api/collections.html#Mongo-Collection-allow\n   * @summary Shorthands for Mongo.Collection allow method\n   * @returns {Mongo.Collection} Instance\n   */\n  allowClient() {\n    this.collection.allow({\n      insert() { return true; },\n      update() { return true; },\n      remove() { return true; }\n    });\n    return this.collection;\n  }\n\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name unlink\n   * @param {Object} fileRef - fileObj\n   * @param {String} version - [Optional] file's version\n   * @param {Function} callback - [Optional] callback function\n   * @summary Unlink files and it's versions from FS\n   * @returns {FilesCollection} Instance\n   */\n  unlink(fileRef, version, callback) {\n    this._debug(`[FilesCollection] [unlink(${fileRef._id}, ${version})]`);\n    if (version) {\n      if (helpers.isObject(fileRef.versions) && helpers.isObject(fileRef.versions[version]) && fileRef.versions[version].path) {\n        fs.unlink(fileRef.versions[version].path, (callback || noop));\n      }\n    } else {\n      if (helpers.isObject(fileRef.versions)) {\n        for(let vKey in fileRef.versions) {\n          if (fileRef.versions[vKey] && fileRef.versions[vKey].path) {\n            fs.unlink(fileRef.versions[vKey].path, (callback || noop));\n          }\n        }\n      } else {\n        fs.unlink(fileRef.path, (callback || noop));\n      }\n    }\n    return this;\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name _404\n   * @summary Internal method, used to return 404 error\n   * @returns {undefined}\n   */\n  _404(http) {\n    this._debug(`[FilesCollection] [download(${http.request.originalUrl})] [_404] File not found`);\n    const text = 'File Not Found :(';\n\n    if (!http.response.headersSent) {\n      http.response.writeHead(404, {\n        'Content-Type': 'text/plain',\n        'Content-Length': text.length\n      });\n    }\n\n    if (!http.response.finished) {\n      http.response.end(text);\n    }\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name download\n   * @param {Object} http    - Server HTTP object\n   * @param {String} version - Requested file version\n   * @param {Object} fileRef - Requested file Object\n   * @summary Initiates the HTTP response\n   * @returns {undefined}\n   */\n  download(http, version = 'original', fileRef) {\n    let vRef;\n    this._debug(`[FilesCollection] [download(${http.request.originalUrl}, ${version})]`);\n\n    if (fileRef) {\n      if (helpers.has(fileRef, 'versions') && helpers.has(fileRef.versions, version)) {\n        vRef = fileRef.versions[version];\n        vRef._id = fileRef._id;\n      } else {\n        vRef = fileRef;\n      }\n    } else {\n      vRef = false;\n    }\n\n    if (!vRef || !helpers.isObject(vRef)) {\n      return this._404(http);\n    } else if (fileRef) {\n      if (helpers.isFunction(this.downloadCallback) && !this.downloadCallback.call(Object.assign(http, this._getUser(http)), fileRef)) {\n        return this._404(http);\n      }\n\n      if (this.interceptDownload && helpers.isFunction(this.interceptDownload) && this.interceptDownload(http, fileRef, version) === true) {\n        return void 0;\n      }\n\n      fs.stat(vRef.path, (statErr, stats) => bound(() => {\n        let responseType;\n        if (statErr || !stats.isFile()) {\n          return this._404(http);\n        }\n\n        if ((stats.size !== vRef.size) && !this.integrityCheck) {\n          vRef.size = stats.size;\n        }\n\n        if ((stats.size !== vRef.size) && this.integrityCheck) {\n          responseType = '400';\n        }\n\n        return this.serve(http, fileRef, vRef, version, null, (responseType || '200'));\n      }));\n      return void 0;\n    }\n    return this._404(http);\n  }\n\n  /**\n   * @locus Server\n   * @memberOf FilesCollection\n   * @name serve\n   * @param {Object} http    - Server HTTP object\n   * @param {Object} fileRef - Requested file Object\n   * @param {Object} vRef    - Requested file version Object\n   * @param {String} version - Requested file version\n   * @param {stream.Readable|null} readableStream - Readable stream, which serves binary file data\n   * @param {String} responseType - Response code\n   * @param {Boolean} force200 - Force 200 response code over 206\n   * @summary Handle and reply to incoming request\n   * @returns {undefined}\n   */\n  serve(http, fileRef, vRef, version = 'original', readableStream = null, _responseType = '200', force200 = false) {\n    let partiral = false;\n    let reqRange = false;\n    let dispositionType = '';\n    let start;\n    let end;\n    let take;\n    let responseType = _responseType;\n\n    if (http.params.query.download && (http.params.query.download === 'true')) {\n      dispositionType = 'attachment; ';\n    } else {\n      dispositionType = 'inline; ';\n    }\n\n    const dispositionName = `filename=\\\"${encodeURI(vRef.name || fileRef.name).replace(/\\,/g, '%2C')}\\\"; filename*=UTF-8''${encodeURIComponent(vRef.name || fileRef.name)}; `;\n    const dispositionEncoding = 'charset=UTF-8';\n\n    if (!http.response.headersSent) {\n      http.response.setHeader('Content-Disposition', dispositionType + dispositionName + dispositionEncoding);\n    }\n\n    if (http.request.headers.range && !force200) {\n      partiral = true;\n      const array = http.request.headers.range.split(/bytes=([0-9]*)-([0-9]*)/);\n      start = parseInt(array[1]);\n      end = parseInt(array[2]);\n      if (isNaN(end)) {\n        end = vRef.size - 1;\n      }\n      take = end - start;\n    } else {\n      start = 0;\n      end = vRef.size - 1;\n      take = vRef.size;\n    }\n\n    if (partiral || (http.params.query.play && (http.params.query.play === 'true'))) {\n      reqRange = {start, end};\n      if (isNaN(start) && !isNaN(end)) {\n        reqRange.start = end - take;\n        reqRange.end = end;\n      }\n      if (!isNaN(start) && isNaN(end)) {\n        reqRange.start = start;\n        reqRange.end = start + take;\n      }\n\n      if ((start + take) >= vRef.size) {\n        reqRange.end = vRef.size - 1;\n      }\n\n      if (this.strict && ((reqRange.start >= (vRef.size - 1)) || (reqRange.end > (vRef.size - 1)))) {\n        responseType = '416';\n      } else {\n        responseType = '206';\n      }\n    } else {\n      responseType = '200';\n    }\n\n    const streamErrorHandler = (error) => {\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [500]`, error);\n      if (!http.response.finished) {\n        http.response.end(error.toString());\n      }\n    };\n\n    const headers = helpers.isFunction(this.responseHeaders) ? this.responseHeaders(responseType, fileRef, vRef, version, http) : this.responseHeaders;\n\n    if (!headers['Cache-Control']) {\n      if (!http.response.headersSent) {\n        http.response.setHeader('Cache-Control', this.cacheControl);\n      }\n    }\n\n    for (let key in headers) {\n      if (!http.response.headersSent) {\n        http.response.setHeader(key, headers[key]);\n      }\n    }\n\n    const respond = (stream, code) => {\n      stream._isEnded = false;\n      const closeStreamCb = (closeError) => {\n        if (!closeError) {\n          stream._isEnded = true;\n        } else {\n          this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [respond] [closeStreamCb] (this is error on the stream we wish to forcefully close after it isn't needed anymore. It's okay that it throws errors. Consider this as purely informational message)`, closeError);\n        }\n      };\n\n      const closeStream = () => {\n        if (!stream._isEnded && !stream.destroyed) {\n          try {\n            if (typeof stream.close === 'function') {\n              stream.close(closeStreamCb);\n            } else if (typeof stream.end === 'function') {\n              stream.end(closeStreamCb);\n            } else if (typeof stream.destroy === 'function') {\n              stream.destroy('Got to close this stream', closeStreamCb);\n            }\n          } catch (closeStreamError) {\n            // Perhaps one of the method has thrown an error\n            // or stream has been already ended/closed/exhausted\n          }\n        }\n      };\n\n      if (!http.response.headersSent && readableStream) {\n        http.response.writeHead(code);\n      }\n\n      http.request.on('aborted', () => {\n        http.request.aborted = true;\n      });\n\n      stream.on('open', () => {\n        if (!http.response.headersSent) {\n          http.response.writeHead(code);\n        }\n      }).on('abort', () => {\n        closeStream();\n        if (!http.response.finished) {\n          http.response.end();\n        }\n        if (!http.request.aborted) {\n          http.request.destroy();\n        }\n      }).on('error', (err) => {\n        closeStream();\n        streamErrorHandler(err);\n      }).on('end', () => {\n        if (!http.response.finished) {\n          http.response.end();\n        }\n      }).pipe(http.response);\n    };\n\n    switch (responseType) {\n    case '400':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [400] Content-Length mismatch!`);\n      var text = 'Content-Length mismatch!';\n\n      if (!http.response.headersSent) {\n        http.response.writeHead(400, {\n          'Content-Type': 'text/plain',\n          'Content-Length': text.length\n        });\n      }\n\n      if (!http.response.finished) {\n        http.response.end(text);\n      }\n      break;\n    case '404':\n      this._404(http);\n      break;\n    case '416':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [416] Content-Range is not specified!`);\n      if (!http.response.headersSent) {\n        http.response.writeHead(416);\n      }\n      if (!http.response.finished) {\n        http.response.end();\n      }\n      break;\n    case '206':\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [206]`);\n      if (!http.response.headersSent) {\n        http.response.setHeader('Content-Range', `bytes ${reqRange.start}-${reqRange.end}/${vRef.size}`);\n      }\n      respond(readableStream || fs.createReadStream(vRef.path, {start: reqRange.start, end: reqRange.end}), 206);\n      break;\n    default:\n      if (!http.response.headersSent) {\n        http.response.setHeader('Content-Length', `${vRef.size}`);\n      }\n      this._debug(`[FilesCollection] [serve(${vRef.path}, ${version})] [200]`);\n      respond(readableStream || fs.createReadStream(vRef.path), 200);\n      break;\n    }\n  }\n}\n\nexport { FilesCollection, helpers };\n","import { EventEmitter } from 'eventemitter3';\nimport { check, Match } from 'meteor/check';\nimport { formatFleURL, helpers } from './lib.js';\nimport { FilesCursor, FileCursor } from './cursor.js';\n\nexport default class FilesCollectionCore extends EventEmitter {\n  constructor() {\n    super();\n  }\n\n  static __helpers = helpers;\n\n  static schema = {\n    _id: {\n      type: String\n    },\n    size: {\n      type: Number\n    },\n    name: {\n      type: String\n    },\n    type: {\n      type: String\n    },\n    path: {\n      type: String\n    },\n    isVideo: {\n      type: Boolean\n    },\n    isAudio: {\n      type: Boolean\n    },\n    isImage: {\n      type: Boolean\n    },\n    isText: {\n      type: Boolean\n    },\n    isJSON: {\n      type: Boolean\n    },\n    isPDF: {\n      type: Boolean\n    },\n    extension: {\n      type: String,\n      optional: true\n    },\n    ext: {\n      type: String,\n      optional: true\n    },\n    extensionWithDot: {\n      type: String,\n      optional: true\n    },\n    mime: {\n      type: String,\n      optional: true\n    },\n    'mime-type': {\n      type: String,\n      optional: true\n    },\n    _storagePath: {\n      type: String\n    },\n    _downloadRoute: {\n      type: String\n    },\n    _collectionName: {\n      type: String\n    },\n    public: {\n      type: Boolean,\n      optional: true\n    },\n    meta: {\n      type: Object,\n      blackbox: true,\n      optional: true\n    },\n    userId: {\n      type: String,\n      optional: true\n    },\n    updatedAt: {\n      type: Date,\n      optional: true\n    },\n    versions: {\n      type: Object,\n      blackbox: true\n    }\n  };\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _debug\n   * @summary Print logs in debug mode\n   * @returns {void}\n   */\n  _debug() {\n    if (this.debug) {\n      (console.info || console.log || function () { }).apply(void 0, arguments);\n    }\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getFileName\n   * @param {Object} fileData - File Object\n   * @summary Returns file's name\n   * @returns {String}\n   */\n  _getFileName(fileData) {\n    const fileName = fileData.name || fileData.fileName;\n    if (helpers.isString(fileName) && (fileName.length > 0)) {\n      return (fileData.name || fileData.fileName).replace(/^\\.\\.+/, '').replace(/\\.{2,}/g, '.').replace(/\\//g, '');\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _getExt\n   * @param {String} FileName - File name\n   * @summary Get extension from FileName\n   * @returns {Object}\n   */\n  _getExt(fileName) {\n    if (fileName.includes('.')) {\n      const extension = (fileName.split('.').pop().split('?')[0] || '').toLowerCase().replace(/([^a-z0-9\\-\\_\\.]+)/gi, '').substring(0, 20);\n      return { ext: extension, extension, extensionWithDot: `.${extension}` };\n    }\n    return { ext: '', extension: '', extensionWithDot: '' };\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _updateFileTypes\n   * @param {Object} data - File data\n   * @summary Internal method. Classify file based on 'type' field\n   */\n  _updateFileTypes(data) {\n    data.isVideo = /^video\\//i.test(data.type);\n    data.isAudio = /^audio\\//i.test(data.type);\n    data.isImage = /^image\\//i.test(data.type);\n    data.isText = /^text\\//i.test(data.type);\n    data.isJSON = /^application\\/json$/i.test(data.type);\n    data.isPDF = /^application\\/(x-)?pdf$/i.test(data.type);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name _dataToSchema\n   * @param {Object} data - File data\n   * @summary Internal method. Build object in accordance with default schema from File data\n   * @returns {Object}\n   */\n  _dataToSchema(data) {\n    const ds = {\n      name: data.name,\n      extension: data.extension,\n      ext: data.extension,\n      extensionWithDot: `.${data.extension}`,\n      path: data.path,\n      meta: data.meta,\n      type: data.type,\n      mime: data.type,\n      'mime-type': data.type,\n      size: data.size,\n      userId: data.userId || null,\n      versions: {\n        original: {\n          path: data.path,\n          size: data.size,\n          type: data.type,\n          extension: data.extension\n        }\n      },\n      _downloadRoute: data._downloadRoute || this.downloadRoute,\n      _collectionName: data._collectionName || this.collectionName\n    };\n\n    //Optional fileId\n    if (data.fileId) {\n      ds._id = data.fileId;\n    }\n\n    this._updateFileTypes(ds);\n    ds._storagePath = data._storagePath || this.storagePath(Object.assign({}, data, ds));\n    return ds;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name findOne\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object} options - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching document Object\n   * @returns {FileCursor} Instance\n   */\n  findOne(selector = {}, options) {\n    this._debug(`[FilesCollection] [findOne(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    const doc = this.collection.findOne(selector, options);\n    if (doc) {\n      return new FileCursor(doc, this);\n    }\n    return doc;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name find\n   * @param {String|Object} selector - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n   * @param {Object}        options  - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#sortspecifiers)\n   * @summary Find and return Cursor for matching documents\n   * @returns {FilesCursor} Instance\n   */\n  find(selector = {}, options) {\n    this._debug(`[FilesCollection] [find(${JSON.stringify(selector)}, ${JSON.stringify(options)})]`);\n    check(selector, Match.Optional(Match.OneOf(Object, String, Boolean, Number, null)));\n    check(options, Match.Optional(Object));\n\n    return new FilesCursor(selector, options, this);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name update\n   * @see http://docs.meteor.com/#/full/update\n   * @summary link Mongo.Collection update method\n   * @returns {Mongo.Collection} Instance\n   */\n  update() {\n    this.collection.update.apply(this.collection, arguments);\n    return this.collection;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCollectionCore\n   * @name link\n   * @param {Object} fileRef - File reference object\n   * @param {String} version - Version of file you would like to request\n   * @param {String} uriBase - [Optional] URI base, see - https://github.com/veliovgroup/Meteor-Files/issues/626\n   * @summary Returns downloadable URL\n   * @returns {String} Empty string returned in case if file not found in DB\n   */\n  link(fileRef, version = 'original', uriBase) {\n    this._debug(`[FilesCollection] [link(${(helpers.isObject(fileRef) ? fileRef._id : void 0)}, ${version})]`);\n    check(fileRef, Object);\n\n    if (!fileRef) {\n      return '';\n    }\n    return formatFleURL(fileRef, version, uriBase);\n  }\n}\n","import { Meteor } from 'meteor/meteor';\n\n/*\n * @private\n * @locus Anywhere\n * @class FileCursor\n * @param _fileRef    {Object} - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Internal class, represents each record in `FilesCursor.each()` or document returned from `.findOne()` method\n */\nexport class FileCursor {\n  constructor(_fileRef, _collection) {\n    this._fileRef = _fileRef;\n    this._collection = _collection;\n    Object.assign(this, _fileRef);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Remove document\n   * @returns {FileCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FileCursor] [remove()]');\n    if (this._fileRef) {\n      this._collection.remove(this._fileRef._id, callback);\n    } else {\n      callback && callback(new Meteor.Error(404, 'No such file'));\n    }\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name link\n   * @param version {String} - Name of file's subversion\n   * @param uriBase {String} - [Optional] URI base, see - https://github.com/veliovgroup/Meteor-Files/issues/626\n   * @summary Returns downloadable URL to File\n   * @returns {String}\n   */\n  link(version = 'original', uriBase) {\n    this._collection._debug(`[FilesCollection] [FileCursor] [link(${version})]`);\n    if (this._fileRef) {\n      return this._collection.link(this._fileRef, version, uriBase);\n    }\n    return '';\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name get\n   * @param property {String} - Name of sub-object property\n   * @summary Returns current document as a plain Object, if `property` is specified - returns value of sub-object property\n   * @returns {Object|mix}\n   */\n  get(property) {\n    this._collection._debug(`[FilesCollection] [FileCursor] [get(${property})]`);\n    if (property) {\n      return this._fileRef[property];\n    }\n    return this._fileRef;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name fetch\n   * @summary Returns document as plain Object in Array\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FileCursor] [fetch()]');\n    return [this._fileRef];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FileCursor\n   * @name with\n   * @summary Returns reactive version of current FileCursor, useful to use with `{{#with}}...{{/with}}` block template helper\n   * @returns {[Object]}\n   */\n  with() {\n    this._collection._debug('[FilesCollection] [FileCursor] [with()]');\n    return Object.assign(this, this._collection.collection.findOne(this._fileRef._id));\n  }\n}\n\n/*\n * @private\n * @locus Anywhere\n * @class FilesCursor\n * @param _selector   {String|Object}   - Mongo-Style selector (http://docs.meteor.com/api/collections.html#selectors)\n * @param options     {Object}          - Mongo-Style selector Options (http://docs.meteor.com/api/collections.html#selectors)\n * @param _collection {FilesCollection} - FilesCollection Instance\n * @summary Implementation of Cursor for FilesCollection\n */\nexport class FilesCursor {\n  constructor(_selector = {}, options, _collection) {\n    this._collection = _collection;\n    this._selector = _selector;\n    this._current = -1;\n    this.cursor = this._collection.collection.find(this._selector, options);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name get\n   * @summary Returns all matching document(s) as an Array. Alias of `.fetch()`\n   * @returns {[Object]}\n   */\n  get() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [get()]');\n    return this.cursor.fetch();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasNext\n   * @summary Returns `true` if there is next item available on Cursor\n   * @returns {Boolean}\n   */\n  hasNext() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasNext()]');\n    return this._current < (this.cursor.count() - 1);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name next\n   * @summary Returns next item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  next() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [next()]');\n    this.cursor.fetch()[++this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name hasPrevious\n   * @summary Returns `true` if there is previous item available on Cursor\n   * @returns {Boolean}\n   */\n  hasPrevious() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [hasPrevious()]');\n    return this._current !== -1;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name previous\n   * @summary Returns previous item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  previous() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [previous()]');\n    this.cursor.fetch()[--this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name fetch\n   * @summary Returns all matching document(s) as an Array.\n   * @returns {[Object]}\n   */\n  fetch() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [fetch()]');\n    return this.cursor.fetch() || [];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name first\n   * @summary Returns first item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  first() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [first()]');\n    this._current = 0;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name last\n   * @summary Returns last item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  last() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [last()]');\n    this._current = this.count() - 1;\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name count\n   * @summary Returns the number of documents that match a query\n   * @returns {Number}\n   */\n  count() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [count()]');\n    return this.cursor.count();\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name remove\n   * @param callback {Function} - Triggered asynchronously after item is removed or failed to be removed\n   * @summary Removes all documents that match a query\n   * @returns {FilesCursor}\n   */\n  remove(callback) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [remove()]');\n    this._collection.remove(this._selector, callback);\n    return this;\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name forEach\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Call `callback` once for each matching document, sequentially and synchronously.\n   * @returns {undefined}\n   */\n  forEach(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [forEach()]');\n    this.cursor.forEach(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name each\n   * @summary Returns an Array of FileCursor made for each document on current cursor\n   *          Useful when using in {{#each FilesCursor#each}}...{{/each}} block template helper\n   * @returns {[FileCursor]}\n   */\n  each() {\n    return this.map((file) => {\n      return new FileCursor(file, this._collection);\n    });\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name map\n   * @param callback {Function} - Function to call. It will be called with three arguments: the `file`, a 0-based index, and cursor itself\n   * @param context {Object} - An object which will be the value of `this` inside `callback`\n   * @summary Map `callback` over all matching documents. Returns an Array.\n   * @returns {Array}\n   */\n  map(callback, context = {}) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [map()]');\n    return this.cursor.map(callback, context);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name current\n   * @summary Returns current item on Cursor, if available\n   * @returns {Object|undefined}\n   */\n  current() {\n    this._collection._debug('[FilesCollection] [FilesCursor] [current()]');\n    if (this._current < 0) {\n      this._current = 0;\n    }\n    return this.fetch()[this._current];\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observe\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observe\n   * @returns {Object} - live query handle\n   */\n  observe(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observe()]');\n    return this.cursor.observe(callbacks);\n  }\n\n  /*\n   * @locus Anywhere\n   * @memberOf FilesCursor\n   * @name observeChanges\n   * @param callbacks {Object} - Functions to call to deliver the result set as it changes\n   * @summary Watch a query. Receive callbacks as the result set changes. Only the differences between the old and new documents are passed to the callbacks.\n   * @url http://docs.meteor.com/api/collections.html#Mongo-Cursor-observeChanges\n   * @returns {Object} - live query handle\n   */\n  observeChanges(callbacks) {\n    this._collection._debug('[FilesCollection] [FilesCursor] [observeChanges()]');\n    return this.cursor.observeChanges(callbacks);\n  }\n}\n","import { check } from 'meteor/check';\n\nconst helpers = {\n  sanitize(str = '', max = 28, replacement = '-') {\n    return str.replace(/([^a-z0-9\\-\\_]+)/gi, replacement).substring(0, max);\n  },\n  isUndefined(obj) {\n    return obj === void 0;\n  },\n  isObject(obj) {\n    if (this.isArray(obj) || this.isFunction(obj)) {\n      return false;\n    }\n    return obj === Object(obj);\n  },\n  isArray(obj) {\n    return Array.isArray(obj);\n  },\n  isBoolean(obj) {\n    return obj === true || obj === false || Object.prototype.toString.call(obj) === '[object Boolean]';\n  },\n  isFunction(obj) {\n    return typeof obj === 'function' || false;\n  },\n  isDate(date) {\n    return !Number.isNaN(new Date(date).getDate());\n  },\n  isEmpty(obj) {\n    if (this.isDate(obj)) {\n      return false;\n    }\n    if (this.isObject(obj)) {\n      return !Object.keys(obj).length;\n    }\n    if (this.isArray(obj) || this.isString(obj)) {\n      return !obj.length;\n    }\n    return false;\n  },\n  clone(obj) {\n    if (!this.isObject(obj)) return obj;\n    return this.isArray(obj) ? obj.slice() : Object.assign({}, obj);\n  },\n  has(_obj, path) {\n    let obj = _obj;\n    if (!this.isObject(obj)) {\n      return false;\n    }\n    if (!this.isArray(path)) {\n      return this.isObject(obj) && Object.prototype.hasOwnProperty.call(obj, path);\n    }\n\n    const length = path.length;\n    for (let i = 0; i < length; i++) {\n      if (!Object.prototype.hasOwnProperty.call(obj, path[i])) {\n        return false;\n      }\n      obj = obj[path[i]];\n    }\n    return !!length;\n  },\n  omit(obj, ...keys) {\n    const clear = Object.assign({}, obj);\n    for (let i = keys.length - 1; i >= 0; i--) {\n      delete clear[keys[i]];\n    }\n\n    return clear;\n  },\n  now: Date.now,\n  throttle(func, wait, options = {}) {\n    let previous = 0;\n    let timeout = null;\n    let result;\n    const that = this;\n    let self;\n    let args;\n\n    const later = () => {\n      previous = options.leading === false ? 0 : that.now();\n      timeout = null;\n      result = func.apply(self, args);\n      if (!timeout) {\n        self = args = null;\n      }\n    };\n\n    const throttled = function () {\n      const now = that.now();\n      if (!previous && options.leading === false) previous = now;\n      const remaining = wait - (now - previous);\n      self = this;\n      args = arguments;\n      if (remaining <= 0 || remaining > wait) {\n        if (timeout) {\n          clearTimeout(timeout);\n          timeout = null;\n        }\n        previous = now;\n        result = func.apply(self, args);\n        if (!timeout) {\n          self = args = null;\n        }\n      } else if (!timeout && options.trailing !== false) {\n        timeout = setTimeout(later, remaining);\n      }\n      return result;\n    };\n\n    throttled.cancel = () => {\n      clearTimeout(timeout);\n      previous = 0;\n      timeout = self = args = null;\n    };\n\n    return throttled;\n  }\n};\n\nconst _helpers = ['String', 'Number', 'Date'];\nfor (let i = 0; i < _helpers.length; i++) {\n  helpers['is' + _helpers[i]] = function (obj) {\n    return Object.prototype.toString.call(obj) === `[object ${_helpers[i]}]`;\n  };\n}\n\n/*\n * @const {Function} fixJSONParse - Fix issue with Date parse\n */\nconst fixJSONParse = function(obj) {\n  for (let key in obj) {\n    if (helpers.isString(obj[key]) && obj[key].includes('=--JSON-DATE--=')) {\n      obj[key] = obj[key].replace('=--JSON-DATE--=', '');\n      obj[key] = new Date(parseInt(obj[key]));\n    } else if (helpers.isObject(obj[key])) {\n      obj[key] = fixJSONParse(obj[key]);\n    } else if (helpers.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (helpers.isObject(v)) {\n          obj[key][i] = fixJSONParse(v);\n        } else if (helpers.isString(v) && v.includes('=--JSON-DATE--=')) {\n          v = v.replace('=--JSON-DATE--=', '');\n          obj[key][i] = new Date(parseInt(v));\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @const {Function} fixJSONStringify - Fix issue with Date stringify\n */\nconst fixJSONStringify = function(obj) {\n  for (let key in obj) {\n    if (helpers.isDate(obj[key])) {\n      obj[key] = `=--JSON-DATE--=${+obj[key]}`;\n    } else if (helpers.isObject(obj[key])) {\n      obj[key] = fixJSONStringify(obj[key]);\n    } else if (helpers.isArray(obj[key])) {\n      let v;\n      for (let i = 0; i < obj[key].length; i++) {\n        v = obj[key][i];\n        if (helpers.isObject(v)) {\n          obj[key][i] = fixJSONStringify(v);\n        } else if (helpers.isDate(v)) {\n          obj[key][i] = `=--JSON-DATE--=${+v}`;\n        }\n      }\n    }\n  }\n  return obj;\n};\n\n/*\n * @locus Anywhere\n * @private\n * @name formatFleURL\n * @param {Object} fileRef - File reference object\n * @param {String} version - [Optional] Version of file you would like build URL for\n * @param {String} uriBase - [Optional] URI base, see - https://github.com/veliovgroup/Meteor-Files/issues/626\n * @summary Returns formatted URL for file\n * @returns {String} Downloadable link\n */\nconst formatFleURL = (fileRef, version = 'original', _uriBase = (__meteor_runtime_config__ || {}).ROOT_URL) => {\n  check(fileRef, Object);\n  check(version, String);\n  let uriBase = _uriBase;\n\n  if (!helpers.isString(uriBase)) {\n    uriBase = (__meteor_runtime_config__ || {}).ROOT_URL || '/';\n  }\n\n  const _root = uriBase.replace(/\\/+$/, '');\n  const vRef = (fileRef.versions && fileRef.versions[version]) || fileRef || {};\n\n  let ext;\n  if (helpers.isString(vRef.extension)) {\n    ext = `.${vRef.extension.replace(/^\\./, '')}`;\n  } else {\n    ext = '';\n  }\n\n  if (fileRef.public === true) {\n    return _root + (version === 'original' ? `${fileRef._downloadRoute}/${fileRef._id}${ext}` : `${fileRef._downloadRoute}/${version}-${fileRef._id}${ext}`);\n  }\n  return `${_root}${fileRef._downloadRoute}/${fileRef._collectionName}/${fileRef._id}/${version}/${fileRef._id}${ext}`;\n};\n\nexport { fixJSONParse, fixJSONStringify, formatFleURL, helpers };\n","import fs from 'fs-extra';\nimport nodePath from 'path';\nimport { Meteor } from 'meteor/meteor';\nimport { helpers } from './lib.js';\nconst noop = () => {};\n\n/**\n * @const {Object} bound   - Meteor.bindEnvironment (Fiber wrapper)\n * @const {Object} fdCache - File Descriptors Cache\n */\nconst bound = Meteor.bindEnvironment(callback => callback());\nconst fdCache = {};\n\n/**\n * @private\n * @locus Server\n * @class WriteStream\n * @param path        {String} - Path to file on FS\n * @param maxLength   {Number} - Max amount of chunks in stream\n * @param file        {Object} - fileRef Object\n * @param permissions {String} - Permissions which will be set to open descriptor (octal), like: `611` or `0o777`. Default: 0755\n * @summary writableStream wrapper class, makes sure chunks is written in given order. Implementation of queue stream.\n */\nexport default class WriteStream {\n  constructor(path, maxLength, file, permissions) {\n    this.path = path.trim();\n    this.maxLength = maxLength;\n    this.file = file;\n    this.permissions = permissions;\n    if (!this.path || !helpers.isString(this.path)) {\n      return;\n    }\n\n    this.fd = null;\n    this.ended = false;\n    this.aborted = false;\n    this.writtenChunks = 0;\n\n    if (fdCache[this.path] && !fdCache[this.path].ended && !fdCache[this.path].aborted) {\n      this.fd = fdCache[this.path].fd;\n      this.writtenChunks = fdCache[this.path].writtenChunks;\n    } else {\n      fs.stat(this.path, (statError, stats) => {\n        bound(() => {\n          if (statError || !stats.isFile()) {\n            const paths = this.path.split(nodePath.sep);\n            paths.pop();\n            try {\n              fs.mkdirSync(paths.join(nodePath.sep), { recursive: true });\n            } catch (mkdirError) {\n              throw new Meteor.Error(500, `[FilesCollection] [writeStream] [constructor] [mkdirSync] ERROR: can not make/ensure directory \"${paths.join(nodePath.sep)}\"`, mkdirError);\n            }\n\n            try {\n              fs.writeFileSync(this.path, '');\n            } catch (writeFileError) {\n              throw new Meteor.Error(500, `[FilesCollection] [writeStream] [constructor] [writeFileSync] ERROR: can not write file \"${this.path}\"`, writeFileError);\n            }\n          }\n\n          fs.open(this.path, 'r+', this.permissions, (oError, fd) => {\n            bound(() => {\n              if (oError) {\n                this.abort();\n                throw new Meteor.Error(500, '[FilesCollection] [writeStream] [constructor] [open] [Error:]', oError);\n              } else {\n                this.fd = fd;\n                fdCache[this.path] = this;\n              }\n            });\n          });\n        });\n      });\n    }\n  }\n\n  /**\n   * @memberOf writeStream\n   * @name write\n   * @param {Number} num - Chunk position in a stream\n   * @param {Buffer} chunk - Buffer (chunk binary data)\n   * @param {Function} callback - Callback\n   * @summary Write chunk in given order\n   * @returns {Boolean} - True if chunk is sent to stream, false if chunk is set into queue\n   */\n  write(num, chunk, callback) {\n    if (!this.aborted && !this.ended) {\n      if (this.fd) {\n        fs.write(this.fd, chunk, 0, chunk.length, (num - 1) * this.file.chunkSize, (error, written, buffer) => {\n          bound(() => {\n            callback && callback(error, written, buffer);\n            if (error) {\n              Meteor._debug('[FilesCollection] [writeStream] [write] [Error:]', error);\n              this.abort();\n            } else {\n              ++this.writtenChunks;\n            }\n          });\n        });\n      } else {\n        Meteor.setTimeout(() => {\n          this.write(num, chunk, callback);\n        }, 25);\n      }\n    }\n    return false;\n  }\n\n  /**\n   * @memberOf writeStream\n   * @name end\n   * @param {Function} callback - Callback\n   * @summary Finishes writing to writableStream, only after all chunks in queue is written\n   * @returns {Boolean} - True if stream is fulfilled, false if queue is in progress\n   */\n  end(callback) {\n    if (!this.aborted && !this.ended) {\n      if (this.writtenChunks === this.maxLength) {\n        fs.close(this.fd, () => {\n          bound(() => {\n            delete fdCache[this.path];\n            this.ended = true;\n            callback && callback(void 0, true);\n          });\n        });\n        return true;\n      }\n\n      fs.stat(this.path, (error, stat) => {\n        bound(() => {\n          if (!error && stat) {\n            this.writtenChunks = Math.ceil(stat.size / this.file.chunkSize);\n          }\n\n          return Meteor.setTimeout(() => {\n            this.end(callback);\n          }, 25);\n        });\n      });\n    } else {\n      callback && callback(void 0, this.ended);\n    }\n    return false;\n  }\n\n  /**\n   * @memberOf writeStream\n   * @name abort\n   * @param {Function} callback - Callback\n   * @summary Aborts writing to writableStream, removes created file\n   * @returns {Boolean} - True\n   */\n  abort(callback) {\n    this.aborted = true;\n    delete fdCache[this.path];\n    fs.unlink(this.path, (callback || noop));\n    return true;\n  }\n\n  /**\n   * @memberOf writeStream\n   * @name stop\n   * @summary Stop writing to writableStream\n   * @returns {Boolean} - True\n   */\n  stop() {\n    this.aborted = true;\n    delete fdCache[this.path];\n    return true;\n  }\n}\n"]}