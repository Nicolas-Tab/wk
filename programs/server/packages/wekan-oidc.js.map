{"version":3,"sources":["meteor://ðŸ’»app/packages/wekan-oidc/oidc_server.js","meteor://ðŸ’»app/packages/wekan-oidc/loginHandler.js"],"names":["addGroupsWithAttributes","addEmail","changeFullname","changeUsername","module","link","v","Oidc","httpCa","process","env","OAUTH2_CA_CERT","undefined","fs","Npm","require","existsSync","readFileSync","e","console","log","profile","serviceData","userinfo","OAuth","registerService","query","debug","DEBUG","token","getToken","accessToken","access_token","id_token","expiresAt","Date","parseInt","expires_in","claimsInAccessToken","OAUTH2_ADFS_ENABLED","OAUTH2_B2C_ENABLED","getTokenContent","getUserInfo","ocs","data","metadata","id","OAUTH2_ID_MAP","username","OAUTH2_USERNAME_MAP","fullname","OAUTH2_FULLNAME_MAP","ORACLE_OIM_ENABLED","OAUTH2_EMAIL_MAP","email","tokenContent","fields","_","pick","getConfiguration","idTokenWhitelistFields","extend","refresh_token","refreshToken","name","groups","Array","isArray","length","user","Meteor","users","findOne","forEach","groupName","i","_user","isAdmin","call","options","userAgent","release","config","tokenEndpoint","includes","serverTokenEndpoint","serverUrl","requestPermissions","response","postOptions","headers","Accept","params","code","client_id","clientId","client_secret","openSecret","secret","redirect_uri","_redirectUri","grant_type","state","ca","HTTP","post","err","Error","message","error","dataToken","strBasicToken","strBasicToken64","OAUTH2_CLIENT_ID","OAUTH2_SECRET","Buffer","toString","userinfoEndpoint","serverUserinfoEndpoint","getOptions","get","ServiceConfiguration","configurations","service","ConfigError","content","parts","split","header","JSON","parse","from","signature","signed","exp","methods","groupRoutineOnLogin","info","userId","check","Object","String","propagateOidcData","PROPAGATE_OIDC_DATA","boardRoutineOnLogin","oidcUserId","_Users$findOne","defaultBoardParams","DEFAULT_BOARD_ID","defaultBoardId","shift","board","Boards","Users","_id","memberIndex","pluck","members","indexOf","addMember","setMemberPermission","contains","retrieveCredential","credentialToken","credentialSecret","createObject","initArr","objString","functionName","creationString","updateObject","userObjs","obj","collection","count","hash","entries","exports","teamArray","orgArray","teams","orgs","group","initAttributes","displayName","desc","shortName","website","isActive","isOrg","isOrganisation","forceCreate","push","org","Org","unshift","orgHash","team","Team","teamHash","update","$set","some","$push","$unset","user_email","emails","contained","position","mail_hash","splice"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,uBAAuB,EAACC,QAAQ,EAACC,cAAc,EAACC,cAAc;AAACC,MAAM,CAACC,IAAI,CAAC,gBAAgB,EAAC;EAACL,uBAAuBA,CAACM,CAAC,EAAC;IAACN,uBAAuB,GAACM,CAAC;EAAA,CAAC;EAACL,QAAQA,CAACK,CAAC,EAAC;IAACL,QAAQ,GAACK,CAAC;EAAA,CAAC;EAACJ,cAAcA,CAACI,CAAC,EAAC;IAACJ,cAAc,GAACI,CAAC;EAAA,CAAC;EAACH,cAAcA,CAACG,CAAC,EAAC;IAACH,cAAc,GAACG,CAAC;EAAA;AAAC,CAAC,EAAC,CAAC,CAAC;AAE1PC,IAAI,GAAG,CAAC,CAAC;AACTC,MAAM,GAAG,KAAK;AAEd,IAAIC,OAAO,CAACC,GAAG,CAACC,cAAc,KAAKC,SAAS,EAAE;EAC1C,IAAI;IACA,MAAMC,EAAE,GAAGC,GAAG,CAACC,OAAO,CAAC,IAAI,CAAC;IAC5B,IAAIF,EAAE,CAACG,UAAU,CAACP,OAAO,CAACC,GAAG,CAACC,cAAc,CAAC,EAAE;MAC7CH,MAAM,GAAGK,EAAE,CAACI,YAAY,CAACR,OAAO,CAACC,GAAG,CAACC,cAAc,CAAC;IACtD;EACJ,CAAC,CAAC,OAAMO,CAAC,EAAE;IACdC,OAAO,CAACC,GAAG,CAAC,2BAA2B,GAAGX,OAAO,CAACC,GAAG,CAACC,cAAc,CAAC;IACrEQ,OAAO,CAACC,GAAG,CAACF,CAAC,CAAC;EACX;AACJ;AACA,IAAIG,OAAO,GAAG,CAAC,CAAC;AAChB,IAAIC,WAAW,GAAG,CAAC,CAAC;AACpB,IAAIC,QAAQ,GAAG,CAAC,CAAC;AAEjBC,KAAK,CAACC,eAAe,CAAC,MAAM,EAAE,CAAC,EAAE,IAAI,EAAE,UAAUC,KAAK,EAAE;EACtD,IAAIC,KAAK,GAAGlB,OAAO,CAACC,GAAG,CAACkB,KAAK,KAAK,MAAM;EAExC,IAAIC,KAAK,GAAGC,QAAQ,CAACJ,KAAK,CAAC;EAC3B,IAAIC,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,sBAAsB,EAAES,KAAK,CAAC;EAErD,IAAIE,WAAW,GAAGF,KAAK,CAACG,YAAY,IAAIH,KAAK,CAACI,QAAQ;EACtD,IAAIC,SAAS,GAAI,CAAC,IAAIC,IAAI,CAAD,CAAC,GAAK,IAAI,GAAGC,QAAQ,CAACP,KAAK,CAACQ,UAAU,EAAE,EAAE,CAAE;EAErE,IAAIC,mBAAmB,GAAI7B,OAAO,CAACC,GAAG,CAAC6B,mBAAmB,KAAK,MAAM,IAC1C9B,OAAO,CAACC,GAAG,CAAC6B,mBAAmB,KAAK,IAAI,IACxC9B,OAAO,CAACC,GAAG,CAAC8B,kBAAkB,KAAM,MAAM,IAC1C/B,OAAO,CAACC,GAAG,CAAC8B,kBAAkB,KAAM,IAAI,IAAO,KAAK;EAE/E,IAAGF,mBAAmB,EACtB;IACE;IACAf,QAAQ,GAAGkB,eAAe,CAACV,WAAW,CAAC;EACzC,CAAC,MAED;IACE;IACAR,QAAQ,GAAGmB,WAAW,CAACX,WAAW,CAAC;EACrC;EAEA,IAAIR,QAAQ,CAACoB,GAAG,EAAEpB,QAAQ,GAAGA,QAAQ,CAACoB,GAAG,CAACC,IAAI,CAAC,CAAC;EAChD,IAAIrB,QAAQ,CAACsB,QAAQ,EAAEtB,QAAQ,GAAGA,QAAQ,CAACsB,QAAQ,EAAC;EACpD,IAAIlB,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,gBAAgB,EAAEG,QAAQ,CAAC;EAElDD,WAAW,CAACwB,EAAE,GAAGvB,QAAQ,CAACd,OAAO,CAACC,GAAG,CAACqC,aAAa,CAAC,CAAC,CAAC;EACtDzB,WAAW,CAAC0B,QAAQ,GAAGzB,QAAQ,CAACd,OAAO,CAACC,GAAG,CAACuC,mBAAmB,CAAC,CAAC,CAAC;EAClE3B,WAAW,CAAC4B,QAAQ,GAAG3B,QAAQ,CAACd,OAAO,CAACC,GAAG,CAACyC,mBAAmB,CAAC,CAAC,CAAC;EAClE7B,WAAW,CAACS,WAAW,GAAGA,WAAW;EACrCT,WAAW,CAACY,SAAS,GAAGA,SAAS;;EAGjC;EACA,IAAIzB,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,MAAM,IAAI3C,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,IAAI,EAAE;IACxF,IAAI7B,QAAQ,CAACd,OAAO,CAACC,GAAG,CAAC2C,gBAAgB,CAAC,EAAE;MAC1C/B,WAAW,CAACgC,KAAK,GAAG/B,QAAQ,CAACd,OAAO,CAACC,GAAG,CAAC2C,gBAAgB,CAAC;IAC5D,CAAC,MAAM;MACL/B,WAAW,CAACgC,KAAK,GAAG/B,QAAQ,CAACd,OAAO,CAACC,GAAG,CAACuC,mBAAmB,CAAC;IAC/D;EACF;EAEA,IAAIxC,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,MAAM,IAAI3C,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,IAAI,EAAE;IACxF9B,WAAW,CAACgC,KAAK,GAAG/B,QAAQ,CAACd,OAAO,CAACC,GAAG,CAAC2C,gBAAgB,CAAC,CAAC,CAAC;EAC9D;EAEA,IAAI5C,OAAO,CAACC,GAAG,CAAC8B,kBAAkB,KAAM,MAAM,IAAK/B,OAAO,CAACC,GAAG,CAAC8B,kBAAkB,KAAM,IAAI,EAAE;IAC3FlB,WAAW,CAACgC,KAAK,GAAG/B,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;EAC3C;EAEA,IAAIQ,WAAW,EAAE;IACf,IAAIwB,YAAY,GAAGd,eAAe,CAACV,WAAW,CAAC;IAC/C,IAAIyB,MAAM,GAAGC,CAAC,CAACC,IAAI,CAACH,YAAY,EAAEI,gBAAgB,CAAC,CAAC,CAACC,sBAAsB,CAAC;IAC5EH,CAAC,CAACI,MAAM,CAACvC,WAAW,EAAEkC,MAAM,CAAC;EAC/B;EAEA,IAAI3B,KAAK,CAACiC,aAAa,EACrBxC,WAAW,CAACyC,YAAY,GAAGlC,KAAK,CAACiC,aAAa;EAChD,IAAInC,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,mBAAmB,EAAEE,WAAW,CAAC;EAExDD,OAAO,CAAC2C,IAAI,GAAGzC,QAAQ,CAACd,OAAO,CAACC,GAAG,CAACyC,mBAAmB,CAAC,CAAC,CAAC;EAC1D9B,OAAO,CAACiC,KAAK,GAAG/B,QAAQ,CAACd,OAAO,CAACC,GAAG,CAAC2C,gBAAgB,CAAC,CAAC,CAAC;;EAExD,IAAI5C,OAAO,CAACC,GAAG,CAAC8B,kBAAkB,KAAM,MAAM,IAAK/B,OAAO,CAACC,GAAG,CAAC8B,kBAAkB,KAAM,IAAI,EAAE;IAC3FnB,OAAO,CAACiC,KAAK,GAAG/B,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;EACvC;EAEA,IAAII,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,eAAe,EAAEC,OAAO,CAAC;;EAGhD;EACAC,WAAW,CAAC2C,MAAM,GAAI1C,QAAQ,CAAC,QAAQ,CAAC,IAAIA,QAAQ,CAAC,aAAa,CAAC,GAAIA,QAAQ,CAAC,aAAa,CAAC,GAAGA,QAAQ,CAAC,QAAQ,CAAC;EACnH;EACA;EACA;EACA;EACA;EACA,IAAG2C,KAAK,CAACC,OAAO,CAAC7C,WAAW,CAAC2C,MAAM,CAAC,IAAI3C,WAAW,CAAC2C,MAAM,CAACG,MAAM,IAAI,OAAO9C,WAAW,CAAC2C,MAAM,CAAC,CAAC,CAAC,KAAK,QAAQ,EAC9G;IACEI,IAAI,GAAGC,MAAM,CAACC,KAAK,CAACC,OAAO,CAAC;MAAC,KAAK,EAAGlD,WAAW,CAACwB;IAAE,CAAC,CAAC;IAErDxB,WAAW,CAAC2C,MAAM,CAACQ,OAAO,CAAC,UAASC,SAAS,EAAEC,CAAC,EAChD;MAAA,IAAAC,KAAA;MACE,IAAG,CAAAA,KAAA,GAAAP,IAAI,cAAAO,KAAA,eAAJA,KAAA,CAAMC,OAAO,IAAIF,CAAC,IAAI,CAAC,EAC1B;QACE;QACArD,WAAW,CAAC2C,MAAM,CAACU,CAAC,CAAC,GAAG;UAAC,SAAS,EAAE;QAAI,CAAC;QACzCrD,WAAW,CAAC2C,MAAM,CAACU,CAAC,CAAC,CAAC,aAAa,CAAC,GAAED,SAAS;MACjD,CAAC,MAED;QACEpD,WAAW,CAAC2C,MAAM,CAACU,CAAC,CAAC,GAAG;UAAC,aAAa,EAAED;QAAS,CAAC;MACpD;IACF,CAAC,CAAC;EACJ;;EAEA;EACA;EACAJ,MAAM,CAACQ,IAAI,CAAC,qBAAqB,EAACxD,WAAW,EAAE,EAAE,GAACA,WAAW,CAACwB,EAAE,CAAC;EACjEwB,MAAM,CAACQ,IAAI,CAAC,qBAAqB,EAACxD,WAAW,EAAE,EAAE,GAACA,WAAW,CAACwB,EAAE,CAAC;EAEjE,OAAO;IACLxB,WAAW,EAAEA,WAAW;IACxByD,OAAO,EAAE;MAAE1D,OAAO,EAAEA;IAAQ;EAC9B,CAAC;AACH,CAAC,CAAC;AAEF,IAAI2D,SAAS,GAAG,QAAQ;AACxB,IAAIV,MAAM,CAACW,OAAO,EAAE;EAClBD,SAAS,IAAI,GAAG,GAAGV,MAAM,CAACW,OAAO;AACnC;AAEA,IAAIxE,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,MAAM,IAAI3C,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,IAAI,EAAE;EACxF,IAAItB,QAAQ,GAAG,SAAAA,CAAUJ,KAAK,EAAE;IAC9B,IAAIC,KAAK,GAAGlB,OAAO,CAACC,GAAG,CAACkB,KAAK,KAAK,MAAM;IACxC,IAAIsD,MAAM,GAAGvB,gBAAgB,CAAC,CAAC;IAC/B,IAAGuB,MAAM,CAACC,aAAa,CAACC,QAAQ,CAAC,UAAU,CAAC,EAAC;MAC3C,IAAIC,mBAAmB,GAAGH,MAAM,CAACC,aAAa;IAChD,CAAC,MAAI;MACH,IAAIE,mBAAmB,GAAGH,MAAM,CAACI,SAAS,GAAGJ,MAAM,CAACC,aAAa;IACnE;IACA,IAAII,kBAAkB,GAAGL,MAAM,CAACK,kBAAkB;IAClD,IAAIC,QAAQ;IAEZ,IAAI;MACF,IAAIC,WAAW,GAAG;QACdC,OAAO,EAAE;UACPC,MAAM,EAAE,kBAAkB;UAC1B,YAAY,EAAEX;QAChB,CAAC;QACDY,MAAM,EAAE;UACNC,IAAI,EAAEnE,KAAK,CAACmE,IAAI;UAChBC,SAAS,EAAEZ,MAAM,CAACa,QAAQ;UAC1BC,aAAa,EAAExE,KAAK,CAACyE,UAAU,CAACf,MAAM,CAACgB,MAAM,CAAC;UAC9CC,YAAY,EAAE3E,KAAK,CAAC4E,YAAY,CAAC,MAAM,EAAElB,MAAM,CAAC;UAChDmB,UAAU,EAAE,oBAAoB;UAChCC,KAAK,EAAE5E,KAAK,CAAC4E;QACf;MACF,CAAC;MACH,IAAI9F,MAAM,EAAE;QACjBiF,WAAW,CAAC,mBAAmB,CAAC,GAAG;UAAEc,EAAE,EAAE/F;QAAO,CAAC;MAC5C;MACAgF,QAAQ,GAAGgB,IAAI,CAACC,IAAI,CAACpB,mBAAmB,EAAEI,WAAW,CAAC;IACxD,CAAC,CAAC,OAAOiB,GAAG,EAAE;MACZ,MAAMjD,CAAC,CAACI,MAAM,CAAC,IAAI8C,KAAK,CAAC,gCAAgC,GAAGtB,mBAAmB,GAAG,IAAI,GAAGqB,GAAG,CAACE,OAAO,CAAC,EACnG;QAAEpB,QAAQ,EAAEkB,GAAG,CAAClB;MAAS,CAAC,CAAC;IAC/B;IACA,IAAIA,QAAQ,CAAC5C,IAAI,CAACiE,KAAK,EAAE;MACvB;MACA,MAAM,IAAIF,KAAK,CAAC,yCAAyC,GAAGtB,mBAAmB,GAAG,IAAI,GAAGG,QAAQ,CAAC5C,IAAI,CAACiE,KAAK,CAAC;IAC/G,CAAC,MAAM;MACL,IAAIlF,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,0BAA0B,EAAEoE,QAAQ,CAAC5C,IAAI,CAAC;MACjE,OAAO4C,QAAQ,CAAC5C,IAAI;IACtB;EACF,CAAC;AACH;AAEA,IAAInC,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,MAAM,IAAI3C,OAAO,CAACC,GAAG,CAAC0C,kBAAkB,KAAK,IAAI,EAAE;EAExF,IAAItB,QAAQ,GAAG,SAAAA,CAAUJ,KAAK,EAAE;IAC9B,IAAIC,KAAK,GAAGlB,OAAO,CAACC,GAAG,CAACkB,KAAK,KAAK,MAAM;IACxC,IAAIsD,MAAM,GAAGvB,gBAAgB,CAAC,CAAC;IAC/B,IAAGuB,MAAM,CAACC,aAAa,CAACC,QAAQ,CAAC,UAAU,CAAC,EAAC;MAC3C,IAAIC,mBAAmB,GAAGH,MAAM,CAACC,aAAa;IAChD,CAAC,MAAI;MACH,IAAIE,mBAAmB,GAAGH,MAAM,CAACI,SAAS,GAAGJ,MAAM,CAACC,aAAa;IACnE;IACA,IAAII,kBAAkB,GAAGL,MAAM,CAACK,kBAAkB;IAClD,IAAIC,QAAQ;;IAEZ;IACA,IAAIsB,SAAS,GAAC,IAAI;IAClB,IAAIC,aAAa,GAAC,IAAI;IACtB,IAAIC,eAAe,GAAC,IAAI;IAExBF,SAAS,GAAGrG,OAAO,CAACC,GAAG,CAACuG,gBAAgB,GAAG,GAAG,GAAGxG,OAAO,CAACC,GAAG,CAACwG,aAAa;IAC1EH,aAAa,GAAG,IAAII,MAAM,CAACL,SAAS,CAAC;IACrCE,eAAe,GAAGD,aAAa,CAACK,QAAQ,CAAC,QAAQ,CAAC;;IAElD;IACA,IAAIzF,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,eAAe,EAAE4F,eAAe,CAAC;IAExD,IAAI;MACF,IAAIvB,WAAW,GAAG;QACdC,OAAO,EAAE;UACPC,MAAM,EAAE,kBAAkB;UAC1B,YAAY,EAAEX,SAAS;UACvB,eAAe,EAAE,QAAQ,GAAGgC;QAC9B,CAAC;QACDpB,MAAM,EAAE;UACNC,IAAI,EAAEnE,KAAK,CAACmE,IAAI;UAChBC,SAAS,EAAEZ,MAAM,CAACa,QAAQ;UAC1BC,aAAa,EAAExE,KAAK,CAACyE,UAAU,CAACf,MAAM,CAACgB,MAAM,CAAC;UAC9CC,YAAY,EAAE3E,KAAK,CAAC4E,YAAY,CAAC,MAAM,EAAElB,MAAM,CAAC;UAChDmB,UAAU,EAAE,oBAAoB;UAChCC,KAAK,EAAE5E,KAAK,CAAC4E;QACf;MACF,CAAC;MACH,IAAI9F,MAAM,EAAE;QACjBiF,WAAW,CAAC,mBAAmB,CAAC,GAAG;UAAEc,EAAE,EAAE/F;QAAO,CAAC;MAC5C;MACAgF,QAAQ,GAAGgB,IAAI,CAACC,IAAI,CAACpB,mBAAmB,EAAEI,WAAW,CAAC;IACxD,CAAC,CAAC,OAAOiB,GAAG,EAAE;MACZ,MAAMjD,CAAC,CAACI,MAAM,CAAC,IAAI8C,KAAK,CAAC,gCAAgC,GAAGtB,mBAAmB,GAAG,IAAI,GAAGqB,GAAG,CAACE,OAAO,CAAC,EACnG;QAAEpB,QAAQ,EAAEkB,GAAG,CAAClB;MAAS,CAAC,CAAC;IAC/B;IACA,IAAIA,QAAQ,CAAC5C,IAAI,CAACiE,KAAK,EAAE;MACvB;MACA,MAAM,IAAIF,KAAK,CAAC,yCAAyC,GAAGtB,mBAAmB,GAAG,IAAI,GAAGG,QAAQ,CAAC5C,IAAI,CAACiE,KAAK,CAAC;IAC/G,CAAC,MAAM;MACL;MACA,IAAIlF,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,0BAA0B,EAAEoE,QAAQ,CAAC5C,IAAI,CAAC;MACjE,OAAO4C,QAAQ,CAAC5C,IAAI;IACtB;EACF,CAAC;AACH;AAGA,IAAIF,WAAW,GAAG,SAAAA,CAAUX,WAAW,EAAE;EACvC,IAAIJ,KAAK,GAAGlB,OAAO,CAACC,GAAG,CAACkB,KAAK,KAAK,MAAM;EACxC,IAAIsD,MAAM,GAAGvB,gBAAgB,CAAC,CAAC;EAC/B;EACA;EACA,IAAIuB,MAAM,CAACmC,gBAAgB,CAACjC,QAAQ,CAAC,UAAU,CAAC,EAAE;IAChD,IAAIkC,sBAAsB,GAAGpC,MAAM,CAACmC,gBAAgB;EACtD,CAAC,MAAM;IACL,IAAIC,sBAAsB,GAAGpC,MAAM,CAACI,SAAS,GAAGJ,MAAM,CAACmC,gBAAgB;EACzE;EACA,IAAI7B,QAAQ;EACZ,IAAI;IACF,IAAI+B,UAAU,GAAG;MACb7B,OAAO,EAAE;QACP,YAAY,EAAEV,SAAS;QACvB,eAAe,EAAE,SAAS,GAAGjD;MAC/B;IACF,CAAC;IACH,IAAIvB,MAAM,EAAE;MACV+G,UAAU,CAAC,mBAAmB,CAAC,GAAG;QAAEhB,EAAE,EAAE/F;MAAO,CAAC;IAClD;IACAgF,QAAQ,GAAGgB,IAAI,CAACgB,GAAG,CAACF,sBAAsB,EAAEC,UAAU,CAAC;EACzD,CAAC,CAAC,OAAOb,GAAG,EAAE;IACZ,MAAMjD,CAAC,CAACI,MAAM,CAAC,IAAI8C,KAAK,CAAC,qCAAqC,GAAGW,sBAAsB,GAAG,IAAI,GAAGZ,GAAG,CAACE,OAAO,CAAC,EAC9F;MAACpB,QAAQ,EAAEkB,GAAG,CAAClB;IAAQ,CAAC,CAAC;EAC1C;EACA,IAAI7D,KAAK,EAAER,OAAO,CAACC,GAAG,CAAC,6BAA6B,EAAEoE,QAAQ,CAAC5C,IAAI,CAAC;EACpE,OAAO4C,QAAQ,CAAC5C,IAAI;AACtB,CAAC;AAED,IAAIe,gBAAgB,GAAG,SAAAA,CAAA,EAAY;EACjC,IAAIuB,MAAM,GAAGuC,oBAAoB,CAACC,cAAc,CAAClD,OAAO,CAAC;IAAEmD,OAAO,EAAE;EAAO,CAAC,CAAC;EAC7E,IAAI,CAACzC,MAAM,EAAE;IACX,MAAM,IAAIuC,oBAAoB,CAACG,WAAW,CAAC,8BAA8B,CAAC;EAC5E;EACA,OAAO1C,MAAM;AACf,CAAC;AAED,IAAIzC,eAAe,GAAG,SAAAA,CAAUZ,KAAK,EAAE;EACrC,IAAIgG,OAAO,GAAG,IAAI;EAClB,IAAIhG,KAAK,EAAE;IACT,IAAI;MACF,IAAIiG,KAAK,GAAGjG,KAAK,CAACkG,KAAK,CAAC,GAAG,CAAC;MAC5B,IAAIC,MAAM,GAAGC,IAAI,CAACC,KAAK,CAACf,MAAM,CAACgB,IAAI,CAACL,KAAK,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,CAACV,QAAQ,CAAC,CAAC,CAAC;MACnES,OAAO,GAAGI,IAAI,CAACC,KAAK,CAACf,MAAM,CAACgB,IAAI,CAACL,KAAK,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC,CAACV,QAAQ,CAAC,CAAC,CAAC;MAChE,IAAIgB,SAAS,GAAGjB,MAAM,CAACgB,IAAI,CAACL,KAAK,CAAC,CAAC,CAAC,EAAE,QAAQ,CAAC;MAC/C,IAAIO,MAAM,GAAGP,KAAK,CAAC,CAAC,CAAC,GAAG,GAAG,GAAGA,KAAK,CAAC,CAAC,CAAC;IACxC,CAAC,CAAC,OAAOpB,GAAG,EAAE;MACZ,IAAI,CAACmB,OAAO,GAAG;QACbS,GAAG,EAAE;MACP,CAAC;IACH;EACF;EACA,OAAOT,OAAO;AAChB,CAAC;AACDvD,MAAM,CAACiE,OAAO,CAAC;EACb,qBAAqB,EAAE,SAAAC,CAASC,IAAI,EAAEC,MAAM,EAC5C;IACEC,KAAK,CAACF,IAAI,EAAEG,MAAM,CAAC;IACnBD,KAAK,CAACD,MAAM,EAAEG,MAAM,CAAC;IACrB,IAAIC,iBAAiB,GAAGrI,OAAO,CAACC,GAAG,CAACqI,mBAAmB,IAAI,KAAK;IAChE,IAAID,iBAAiB,EAAE;MACrBvE,KAAK,GAAED,MAAM,CAACC,KAAK;MACnBF,IAAI,GAAGE,KAAK,CAACC,OAAO,CAAC;QAAC,kBAAkB,EAAGkE;MAAM,CAAC,CAAC;MAEnD,IAAGrE,IAAI,EAAE;QACP;QACA,IAAIoE,IAAI,CAACxE,MAAM,EAAE;UACfjE,uBAAuB,CAACqE,IAAI,EAAEoE,IAAI,CAACxE,MAAM,CAAC;QAC5C;QAEA,IAAGwE,IAAI,CAACnF,KAAK,EAAErD,QAAQ,CAACoE,IAAI,EAAEoE,IAAI,CAACnF,KAAK,CAAC;QACzC,IAAGmF,IAAI,CAACvF,QAAQ,EAAEhD,cAAc,CAACmE,IAAI,EAAEoE,IAAI,CAACvF,QAAQ,CAAC;QACrD,IAAGuF,IAAI,CAACzF,QAAQ,EAAE7C,cAAc,CAACkE,IAAI,EAAEoE,IAAI,CAACzF,QAAQ,CAAC;MACvD;IACF;EACF;AACF,CAAC,CAAC;AAEFsB,MAAM,CAACiE,OAAO,CAAC;EACb,qBAAqB,EAAE,SAAAS,CAASP,IAAI,EAAEQ,UAAU,EAChD;IAAA,IAAAC,cAAA;IACEP,KAAK,CAACF,IAAI,EAAEG,MAAM,CAAC;IACnBD,KAAK,CAACM,UAAU,EAAEJ,MAAM,CAAC;IAEzB,MAAMM,kBAAkB,GAAG,CAAC1I,OAAO,CAACC,GAAG,CAAC0I,gBAAgB,IAAI,EAAE,EAAErB,KAAK,CAAC,GAAG,CAAC;IAC1E,MAAMsB,cAAc,GAAGF,kBAAkB,CAACG,KAAK,CAAC,CAAC;IACjD,IAAI,CAACD,cAAc,EAAE;IAErB,MAAME,KAAK,GAAGC,MAAM,CAAChF,OAAO,CAAC6E,cAAc,CAAC;IAC5C,MAAMX,MAAM,IAAAQ,cAAA,GAAGO,KAAK,CAACjF,OAAO,CAAC;MAAE,kBAAkB,EAAEyE;IAAW,CAAC,CAAC,cAAAC,cAAA,uBAAjDA,cAAA,CAAmDQ,GAAG;IACrE,MAAMC,WAAW,GAAGlG,CAAC,CAACmG,KAAK,CAACL,KAAK,aAALA,KAAK,uBAALA,KAAK,CAAEM,OAAO,EAAE,QAAQ,CAAC,CAACC,OAAO,CAACpB,MAAM,CAAC;IACrE,IAAG,CAACa,KAAK,IAAI,CAACb,MAAM,IAAIiB,WAAW,GAAG,CAAC,CAAC,EAAE;IAE1CJ,KAAK,CAACQ,SAAS,CAACrB,MAAM,CAAC;IACvBa,KAAK,CAACS,mBAAmB,CACvBtB,MAAM,EACNS,kBAAkB,CAACc,QAAQ,CAAC,SAAS,CAAC,EACtCd,kBAAkB,CAACc,QAAQ,CAAC,cAAc,CAAC,EAC3Cd,kBAAkB,CAACc,QAAQ,CAAC,gBAAgB,CAAC,EAC7Cd,kBAAkB,CAACc,QAAQ,CAAC,UAAU,CACxC,CAAC;EACH;AACF,CAAC,CAAC;AAEF1J,IAAI,CAAC2J,kBAAkB,GAAG,UAAUC,eAAe,EAAEC,gBAAgB,EAAE;EACrE,OAAO5I,KAAK,CAAC0I,kBAAkB,CAACC,eAAe,EAAEC,gBAAgB,CAAC;AACpE,CAAC,C;;;;;;;;;;;;EC5VD;EACA;EACA;EACA,SAASC,YAAYA,CAACC,OAAO,EAAEC,SAAS,EACxC;IACEC,YAAY,GAAGD,SAAS,KAAK,KAAK,GAAG,sBAAsB,GAAG,uBAAuB;IACrFE,cAAc,GAAG,WAAW,GAAEF,SAAS,GAAG,UAAU;IACpD,OAAOjG,MAAM,CAACQ,IAAI,CAAC0F,YAAY,EAC7BF,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IACV,CAAC;EACL;EACA,SAASI,YAAYA,CAACJ,OAAO,EAAEC,SAAS,EACxC;IACEC,YAAY,GAAGD,SAAS,KAAK,KAAK,GAAG,yBAAyB,GAAG,0BAA0B;IAC3F,OAAOjG,MAAM,CAACQ,IAAI,CAAC0F,YAAY,EAC7BF,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IAAC;IACXA,OAAO,CAAC,CAAC,CAAC;IACV,CAAC;EACL;EACA;EACA;EACA;EACA;EACA;EACA,SAASL,QAAQA,CAACU,QAAQ,EAAEC,GAAG,EAAEC,UAAU,EAC3C;IACE/H,EAAE,GAAG+H,UAAU,GAAC,IAAI;IAEpB,IAAG,OAAOF,QAAQ,IAAI,WAAW,IAAI,CAACA,QAAQ,CAACvG,MAAM,EACrD;MACE,OAAO,KAAK;IACd;IACA,KAAK,MAAM,CAAC0G,KAAK,EAAEC,IAAI,CAAC,IAAInC,MAAM,CAACoC,OAAO,CAACL,QAAQ,CAAC,EACpD;MACE,IAAII,IAAI,CAACjI,EAAE,CAAC,KAAK8H,GAAG,CAAClB,GAAG,EACxB;QACE,OAAO,IAAI;MACb;IACF;IACA,OAAO,KAAK;EACd;EACAtJ,MAAM,CAAC6K,OAAO,GAAG;IAEjB;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACAjL,uBAAuB,EAAE,SAAAA,CAAUqE,IAAI,EAAEJ,MAAM,EAAC;MAC9CiH,SAAS,GAAC,EAAE;MACZC,QAAQ,GAAC,EAAE;MACXtG,OAAO,GAAG,EAAE;MACZuG,KAAK,GAAG/G,IAAI,CAAC+G,KAAK;MAClBC,IAAI,GAAGhH,IAAI,CAACgH,IAAI;MAChB,KAAKC,KAAK,IAAIrH,MAAM,EACpB;QACEsH,cAAc,GAAG,CACfD,KAAK,CAACE,WAAW,EACjBF,KAAK,CAACG,IAAI,IAAIH,KAAK,CAACE,WAAW,EAC/BF,KAAK,CAACI,SAAS,IAAGJ,KAAK,CAACE,WAAW,EACnCF,KAAK,CAACK,OAAO,IAAIL,KAAK,CAACE,WAAW,EAAEF,KAAK,CAACM,QAAQ,IAAI,KAAK,CAAC;QAE9DC,KAAK,GAAGP,KAAK,CAACQ,cAAc,IAAI,KAAK;QACrCC,WAAW,GAAGT,KAAK,CAACS,WAAW,IAAG,KAAK;QACvClH,OAAO,CAACmH,IAAI,CAACV,KAAK,CAACzG,OAAO,IAAI,KAAK,CAAC;QACpC,IAAIgH,KAAK,EACT;UACEI,GAAG,GAAGC,GAAG,CAAC1H,OAAO,CAAC;YAAC,gBAAgB,EAAE8G,KAAK,CAACE;UAAW,CAAC,CAAC;UACxD,IAAGS,GAAG,EACN;YACE,IAAGhC,QAAQ,CAACoB,IAAI,EAAEY,GAAG,EAAE,KAAK,CAAC,EAC7B;cACEV,cAAc,CAACY,OAAO,CAACF,GAAG,CAAC;cAC3BvB,YAAY,CAACa,cAAc,EAAE,KAAK,CAAC;cACnC;YACF;UACF,CAAC,MACI,IAAGQ,WAAW,EACnB;YACE1B,YAAY,CAACkB,cAAc,EAAE,KAAK,CAAC;YACnCU,GAAG,GAAGC,GAAG,CAAC1H,OAAO,CAAC;cAAC,gBAAgB,EAAE8G,KAAK,CAACE;YAAW,CAAC,CAAC;UAC1D,CAAC,MAED;YACE;UACF;UACAY,OAAO,GAAG;YAAC,OAAO,EAAEH,GAAG,CAACvC,GAAG;YAAE,gBAAgB,EAAE4B,KAAK,CAACE;UAAW,CAAC;UACjEL,QAAQ,CAACa,IAAI,CAACI,OAAO,CAAC;QACxB,CAAC,MAGD;UACE;UACAC,IAAI,GAAGC,IAAI,CAAC9H,OAAO,CAAC;YAAC,iBAAiB,EAAE8G,KAAK,CAACE;UAAW,CAAC,CAAC;UAC3D,IAAIa,IAAI,EACR;YACE,IAAGpC,QAAQ,CAACmB,KAAK,EAAEiB,IAAI,EAAE,MAAM,CAAC,EAChC;cACEd,cAAc,CAACY,OAAO,CAACE,IAAI,CAAC;cAC5B3B,YAAY,CAACa,cAAc,EAAE,MAAM,CAAC;cACpC;YACF;UACF,CAAC,MACI,IAAGQ,WAAW,EACnB;YACE1B,YAAY,CAACkB,cAAc,EAAE,MAAM,CAAC;YACpCc,IAAI,GAAGC,IAAI,CAAC9H,OAAO,CAAC;cAAC,iBAAiB,EAAE8G,KAAK,CAACE;YAAW,CAAC,CAAC;UAC7D,CAAC,MAED;YACE;UACF;UACAe,QAAQ,GAAG;YAAC,QAAQ,EAAEF,IAAI,CAAC3C,GAAG;YAAE,iBAAiB,EAAE4B,KAAK,CAACE;UAAW,CAAC;UACrEN,SAAS,CAACc,IAAI,CAACO,QAAQ,CAAC;QAC1B;MACF;MACA;MACA;MACA;;MAEAhI,KAAK,CAACiI,MAAM,CAAC;QAAE9C,GAAG,EAAErF,IAAI,CAACqF;MAAI,CAAC,EAAE;QAAE+C,IAAI,EAAG;UAAC5H,OAAO,EAAEA,OAAO,CAAC6H,IAAI,CAAC/H,CAAC,IAAKA,CAAC,KAAK,IAAK;QAAC;MAAC,CAAC,CAAC;MACrFyG,KAAK,GAAG;QAAC,OAAO,EAAE;UAAC,OAAO,EAAEF;QAAS;MAAC,CAAC;MACvCG,IAAI,GAAG;QAAC,MAAM,EAAE;UAAC,OAAO,EAAEF;QAAQ;MAAC,CAAC;MACpC5G,KAAK,CAACiI,MAAM,CAAC;QAAE9C,GAAG,EAAErF,IAAI,CAACqF;MAAI,CAAC,EAAE;QAAEiD,KAAK,EAAGvB;MAAK,CAAC,CAAC;MACjD7G,KAAK,CAACiI,MAAM,CAAC;QAAE9C,GAAG,EAAErF,IAAI,CAACqF;MAAI,CAAC,EAAE;QAAEiD,KAAK,EAAGtB;MAAI,CAAC,CAAC;MAChD;MACA9G,KAAK,CAACiI,MAAM,CAAC;QAAE9C,GAAG,EAAErF,IAAI,CAACqF;MAAI,CAAC,EAAE;QAAEkD,MAAM,EAAG;UAAC,sBAAsB,EAAE;QAAE;MAAC,CAAC,CAAC;MAEzE;IACF,CAAC;IAEDzM,cAAc,EAAE,SAAAA,CAASkE,IAAI,EAAEL,IAAI,EACnC;MACEhB,QAAQ,GAAG;QAAC,UAAU,EAAEgB;MAAI,CAAC;MAC7B,IAAIK,IAAI,CAACrB,QAAQ,IAAIA,QAAQ,EAAEuB,KAAK,CAACiI,MAAM,CAAC;QAAE9C,GAAG,EAAErF,IAAI,CAACqF;MAAI,CAAC,EAAE;QAAE+C,IAAI,EAAGzJ;MAAQ,CAAC,CAAC;IACpF,CAAC;IACD9C,cAAc,EAAE,SAAAA,CAASmE,IAAI,EAAEL,IAAI,EACnC;MACEhB,QAAQ,GAAG;QAAC,kBAAkB,EAAEgB;MAAI,CAAC;MACrC,IAAIK,IAAI,CAACrB,QAAQ,IAAIA,QAAQ,EAAEuB,KAAK,CAACiI,MAAM,CAAC;QAAE9C,GAAG,EAAErF,IAAI,CAACqF;MAAI,CAAC,EAAE;QAAE+C,IAAI,EAAGzJ;MAAQ,CAAC,CAAC;IACpF,CAAC;IACD/C,QAAQ,EAAE,SAAAA,CAASoE,IAAI,EAAEf,KAAK,EAC9B;MACEuJ,UAAU,GAAGxI,IAAI,CAACyI,MAAM,IAAI,EAAE;MAC9B,IAAIC,SAAS,GAAG,KAAK;MACrBC,QAAQ,GAAG,CAAC;MACZ,KAAK,MAAM,CAAClC,KAAK,EAAEmC,SAAS,CAAC,IAAIrE,MAAM,CAACoC,OAAO,CAAC6B,UAAU,CAAC,EAC3D;QACE,IAAII,SAAS,CAAC,SAAS,CAAC,KAAK3J,KAAK,EAClC;UACEyJ,SAAS,GAAG,IAAI;UAChBC,QAAQ,GAAGlC,KAAK;UAChB;QACF;MACF;MACA,IAAGiC,SAAS,IAAIC,QAAQ,IAAI,CAAC,EAC7B;QACEH,UAAU,CAACK,MAAM,CAACF,QAAQ,EAAC,CAAC,CAAC;QAC7BD,SAAS,GAAG,KAAK;MACnB;MACA,IAAG,CAACA,SAAS,EACb;QACEF,UAAU,CAACV,OAAO,CAAC;UAAC,SAAS,EAAE7I,KAAK;UAAE,UAAU,EAAE;QAAI,CAAC,CAAC;QACxDuJ,UAAU,GAAG;UAAC,QAAQ,EAAEA;QAAU,CAAC;QACnCtI,KAAK,CAACiI,MAAM,CAAC;UAAE9C,GAAG,EAAErF,IAAI,CAACqF;QAAI,CAAC,EAAE;UAAE+C,IAAI,EAAGI;QAAU,CAAC,CAAC;MACvD;IACF;EACA,CAAC;AAAA,EAAA/H,IAAA,OAAA1E,MAAA,E","file":"/packages/wekan-oidc.js","sourcesContent":["import {addGroupsWithAttributes, addEmail, changeFullname, changeUsername} from './loginHandler';\n\nOidc = {};\nhttpCa = false;\n\nif (process.env.OAUTH2_CA_CERT !== undefined) {\n    try {\n        const fs = Npm.require('fs');\n        if (fs.existsSync(process.env.OAUTH2_CA_CERT)) {\n          httpCa = fs.readFileSync(process.env.OAUTH2_CA_CERT);\n        }\n    } catch(e) {\n\tconsole.log('WARNING: failed loading: ' + process.env.OAUTH2_CA_CERT);\n\tconsole.log(e);\n    }\n}\nvar profile = {};\nvar serviceData = {};\nvar userinfo = {};\n\nOAuth.registerService('oidc', 2, null, function (query) {\n  var debug = process.env.DEBUG === 'true';\n\n  var token = getToken(query);\n  if (debug) console.log('XXX: register token:', token);\n\n  var accessToken = token.access_token || token.id_token;\n  var expiresAt = (+new Date) + (1000 * parseInt(token.expires_in, 10));\n\n  var claimsInAccessToken = (process.env.OAUTH2_ADFS_ENABLED === 'true'  ||\n                             process.env.OAUTH2_ADFS_ENABLED === true    ||\n                             process.env.OAUTH2_B2C_ENABLED  === 'true'  ||\n                             process.env.OAUTH2_B2C_ENABLED  === true)   || false;\n\n  if(claimsInAccessToken)\n  {\n    // hack when using custom claims in the accessToken. On premise ADFS. And Azure AD B2C.\n    userinfo = getTokenContent(accessToken);\n  }\n  else\n  {\n    // normal behaviour, getting the claims from UserInfo endpoint.\n    userinfo = getUserInfo(accessToken);\n  }\n\n  if (userinfo.ocs) userinfo = userinfo.ocs.data; // Nextcloud hack\n  if (userinfo.metadata) userinfo = userinfo.metadata // Openshift hack\n  if (debug) console.log('XXX: userinfo:', userinfo);\n\n  serviceData.id = userinfo[process.env.OAUTH2_ID_MAP]; // || userinfo[\"id\"];\n  serviceData.username = userinfo[process.env.OAUTH2_USERNAME_MAP]; // || userinfo[\"uid\"];\n  serviceData.fullname = userinfo[process.env.OAUTH2_FULLNAME_MAP]; // || userinfo[\"displayName\"];\n  serviceData.accessToken = accessToken;\n  serviceData.expiresAt = expiresAt;\n\n\n  // If on Oracle OIM email is empty or null, get info from username\n  if (process.env.ORACLE_OIM_ENABLED === 'true' || process.env.ORACLE_OIM_ENABLED === true) {\n    if (userinfo[process.env.OAUTH2_EMAIL_MAP]) {\n      serviceData.email = userinfo[process.env.OAUTH2_EMAIL_MAP];\n    } else {\n      serviceData.email = userinfo[process.env.OAUTH2_USERNAME_MAP];\n    }\n  }\n\n  if (process.env.ORACLE_OIM_ENABLED !== 'true' && process.env.ORACLE_OIM_ENABLED !== true) {\n    serviceData.email = userinfo[process.env.OAUTH2_EMAIL_MAP]; // || userinfo[\"email\"];\n  }\n\n  if (process.env.OAUTH2_B2C_ENABLED  === 'true'  || process.env.OAUTH2_B2C_ENABLED  === true) {\n    serviceData.email = userinfo[\"emails\"][0];\n  }\n\n  if (accessToken) {\n    var tokenContent = getTokenContent(accessToken);\n    var fields = _.pick(tokenContent, getConfiguration().idTokenWhitelistFields);\n    _.extend(serviceData, fields);\n  }\n\n  if (token.refresh_token)\n    serviceData.refreshToken = token.refresh_token;\n  if (debug) console.log('XXX: serviceData:', serviceData);\n\n  profile.name = userinfo[process.env.OAUTH2_FULLNAME_MAP]; // || userinfo[\"displayName\"];\n  profile.email = userinfo[process.env.OAUTH2_EMAIL_MAP]; // || userinfo[\"email\"];\n\n  if (process.env.OAUTH2_B2C_ENABLED  === 'true'  || process.env.OAUTH2_B2C_ENABLED  === true) {\n    profile.email = userinfo[\"emails\"][0];\n  }\n\n  if (debug) console.log('XXX: profile:', profile);\n\n\n  //temporarily store data from oidc in user.services.oidc.groups to update groups\n  serviceData.groups = (userinfo[\"groups\"] && userinfo[\"wekanGroups\"]) ? userinfo[\"wekanGroups\"] : userinfo[\"groups\"];\n  // groups arriving as array of strings indicate there is no scope set in oidc privider\n  // to assign teams and keep admin privileges\n  // data needs to be treated  differently.\n  // use case: in oidc provider no scope is set, hence no group attributes.\n  //    therefore: keep admin privileges for wekan as before\n  if(Array.isArray(serviceData.groups) && serviceData.groups.length && typeof serviceData.groups[0] === \"string\" )\n  {\n    user = Meteor.users.findOne({'_id':  serviceData.id});\n\n    serviceData.groups.forEach(function(groupName, i)\n    {\n      if(user?.isAdmin && i == 0)\n      {\n        // keep information of user.isAdmin since in loginHandler the user will // be updated regarding group admin privileges provided via oidc\n        serviceData.groups[i] = {\"isAdmin\": true};\n        serviceData.groups[i][\"displayName\"]= groupName;\n      }\n      else\n      {\n        serviceData.groups[i] = {\"displayName\": groupName};\n      }\n    });\n  }\n\n  // Fix OIDC login loop for integer user ID. Thanks to danielkaiser.\n  // https://github.com/wekan/wekan/issues/4795\n  Meteor.call('groupRoutineOnLogin',serviceData, \"\"+serviceData.id);\n  Meteor.call('boardRoutineOnLogin',serviceData, \"\"+serviceData.id);\n\n  return {\n    serviceData: serviceData,\n    options: { profile: profile }\n  };\n});\n\nvar userAgent = \"Meteor\";\nif (Meteor.release) {\n  userAgent += \"/\" + Meteor.release;\n}\n\nif (process.env.ORACLE_OIM_ENABLED !== 'true' && process.env.ORACLE_OIM_ENABLED !== true) {\n  var getToken = function (query) {\n    var debug = process.env.DEBUG === 'true';\n    var config = getConfiguration();\n    if(config.tokenEndpoint.includes('https://')){\n      var serverTokenEndpoint = config.tokenEndpoint;\n    }else{\n      var serverTokenEndpoint = config.serverUrl + config.tokenEndpoint;\n    }\n    var requestPermissions = config.requestPermissions;\n    var response;\n\n    try {\n      var postOptions = {\n          headers: {\n            Accept: 'application/json',\n            \"User-Agent\": userAgent\n          },\n          params: {\n            code: query.code,\n            client_id: config.clientId,\n            client_secret: OAuth.openSecret(config.secret),\n            redirect_uri: OAuth._redirectUri('oidc', config),\n            grant_type: 'authorization_code',\n            state: query.state\n          }\n        };\n      if (httpCa) {\n\tpostOptions['npmRequestOptions'] = { ca: httpCa };\n      }\n      response = HTTP.post(serverTokenEndpoint, postOptions);\n    } catch (err) {\n      throw _.extend(new Error(\"Failed to get token from OIDC \" + serverTokenEndpoint + \": \" + err.message),\n        { response: err.response });\n    }\n    if (response.data.error) {\n      // if the http response was a json object with an error attribute\n      throw new Error(\"Failed to complete handshake with OIDC \" + serverTokenEndpoint + \": \" + response.data.error);\n    } else {\n      if (debug) console.log('XXX: getToken response: ', response.data);\n      return response.data;\n    }\n  };\n}\n\nif (process.env.ORACLE_OIM_ENABLED === 'true' || process.env.ORACLE_OIM_ENABLED === true) {\n\n  var getToken = function (query) {\n    var debug = process.env.DEBUG === 'true';\n    var config = getConfiguration();\n    if(config.tokenEndpoint.includes('https://')){\n      var serverTokenEndpoint = config.tokenEndpoint;\n    }else{\n      var serverTokenEndpoint = config.serverUrl + config.tokenEndpoint;\n    }\n    var requestPermissions = config.requestPermissions;\n    var response;\n\n    // OIM needs basic Authentication token in the header - ClientID + SECRET in base64\n    var dataToken=null;\n    var strBasicToken=null;\n    var strBasicToken64=null;\n\n    dataToken = process.env.OAUTH2_CLIENT_ID + ':' + process.env.OAUTH2_SECRET;\n    strBasicToken = new Buffer(dataToken);\n    strBasicToken64 = strBasicToken.toString('base64');\n\n    // eslint-disable-next-line no-console\n    if (debug) console.log('Basic Token: ', strBasicToken64);\n\n    try {\n      var postOptions = {\n          headers: {\n            Accept: 'application/json',\n            \"User-Agent\": userAgent,\n            \"Authorization\": \"Basic \" + strBasicToken64\n          },\n          params: {\n            code: query.code,\n            client_id: config.clientId,\n            client_secret: OAuth.openSecret(config.secret),\n            redirect_uri: OAuth._redirectUri('oidc', config),\n            grant_type: 'authorization_code',\n            state: query.state\n          }\n        };\n      if (httpCa) {\n\tpostOptions['npmRequestOptions'] = { ca: httpCa };\n      }\n      response = HTTP.post(serverTokenEndpoint, postOptions);\n    } catch (err) {\n      throw _.extend(new Error(\"Failed to get token from OIDC \" + serverTokenEndpoint + \": \" + err.message),\n        { response: err.response });\n    }\n    if (response.data.error) {\n      // if the http response was a json object with an error attribute\n      throw new Error(\"Failed to complete handshake with OIDC \" + serverTokenEndpoint + \": \" + response.data.error);\n    } else {\n      // eslint-disable-next-line no-console\n      if (debug) console.log('XXX: getToken response: ', response.data);\n      return response.data;\n    }\n  };\n}\n\n\nvar getUserInfo = function (accessToken) {\n  var debug = process.env.DEBUG === 'true';\n  var config = getConfiguration();\n  // Some userinfo endpoints use a different base URL than the authorization or token endpoints.\n  // This logic allows the end user to override the setting by providing the full URL to userinfo in their config.\n  if (config.userinfoEndpoint.includes(\"https://\")) {\n    var serverUserinfoEndpoint = config.userinfoEndpoint;\n  } else {\n    var serverUserinfoEndpoint = config.serverUrl + config.userinfoEndpoint;\n  }\n  var response;\n  try {\n    var getOptions = {\n        headers: {\n          \"User-Agent\": userAgent,\n          \"Authorization\": \"Bearer \" + accessToken\n        }\n      };\n    if (httpCa) {\n      getOptions['npmRequestOptions'] = { ca: httpCa };\n    }\n    response = HTTP.get(serverUserinfoEndpoint, getOptions);\n  } catch (err) {\n    throw _.extend(new Error(\"Failed to fetch userinfo from OIDC \" + serverUserinfoEndpoint + \": \" + err.message),\n                   {response: err.response});\n  }\n  if (debug) console.log('XXX: getUserInfo response: ', response.data);\n  return response.data;\n};\n\nvar getConfiguration = function () {\n  var config = ServiceConfiguration.configurations.findOne({ service: 'oidc' });\n  if (!config) {\n    throw new ServiceConfiguration.ConfigError('Service oidc not configured.');\n  }\n  return config;\n};\n\nvar getTokenContent = function (token) {\n  var content = null;\n  if (token) {\n    try {\n      var parts = token.split('.');\n      var header = JSON.parse(Buffer.from(parts[0], 'base64').toString());\n      content = JSON.parse(Buffer.from(parts[1], 'base64').toString());\n      var signature = Buffer.from(parts[2], 'base64');\n      var signed = parts[0] + '.' + parts[1];\n    } catch (err) {\n      this.content = {\n        exp: 0\n      };\n    }\n  }\n  return content;\n}\nMeteor.methods({\n  'groupRoutineOnLogin': function(info, userId)\n  {\n    check(info, Object);\n    check(userId, String);\n    var propagateOidcData = process.env.PROPAGATE_OIDC_DATA || false;\n    if (propagateOidcData) {\n      users= Meteor.users;\n      user = users.findOne({'services.oidc.id':  userId});\n\n      if(user) {\n        //updates/creates Groups and user admin privileges accordingly if not undefined\n        if (info.groups) {\n          addGroupsWithAttributes(user, info.groups);\n        }\n\n        if(info.email) addEmail(user, info.email);\n        if(info.fullname) changeFullname(user, info.fullname);\n        if(info.username) changeUsername(user, info.username);\n      }\n    }\n  }\n});\n\nMeteor.methods({\n  'boardRoutineOnLogin': function(info, oidcUserId)\n  {\n    check(info, Object);\n    check(oidcUserId, String);\n\n    const defaultBoardParams = (process.env.DEFAULT_BOARD_ID || '').split(':');\n    const defaultBoardId = defaultBoardParams.shift()\n    if (!defaultBoardId) return\n\n    const board = Boards.findOne(defaultBoardId)\n    const userId = Users.findOne({ 'services.oidc.id': oidcUserId })?._id\n    const memberIndex = _.pluck(board?.members, 'userId').indexOf(userId);\n    if(!board || !userId || memberIndex > -1) return\n\n    board.addMember(userId)\n    board.setMemberPermission(\n      userId,\n      defaultBoardParams.contains(\"isAdmin\"),\n      defaultBoardParams.contains(\"isNoComments\"),\n      defaultBoardParams.contains(\"isCommentsOnly\"),\n      defaultBoardParams.contains(\"isWorker\")\n    )\n  }\n});\n\nOidc.retrieveCredential = function (credentialToken, credentialSecret) {\n  return OAuth.retrieveCredential(credentialToken, credentialSecret);\n};\n","// creates Object if not present in collection\n// initArr = [displayName, shortName, website, isActive]\n// objString = [\"Org\",\"Team\"] for method mapping\nfunction createObject(initArr, objString)\n{\n  functionName = objString === \"Org\" ? 'setCreateOrgFromOidc' : 'setCreateTeamFromOidc';\n  creationString = 'setCreate'+ objString + 'FromOidc';\n  return Meteor.call(functionName,\n    initArr[0],//displayName\n    initArr[1],//desc\n    initArr[2],//shortName\n    initArr[3],//website\n    initArr[4]//xxxisActive\n    );\n}\nfunction updateObject(initArr, objString)\n{\n  functionName = objString === \"Org\" ? 'setOrgAllFieldsFromOidc' : 'setTeamAllFieldsFromOidc';\n  return Meteor.call(functionName,\n    initArr[0],//team || org Object\n    initArr[1],//displayName\n    initArr[2],//desc\n    initArr[3],//shortName\n    initArr[4],//website\n    initArr[5]//xxxisActive\n    );\n}\n//checks whether obj is in collection of userObjs\n//params\n//e.g. userObjs = user.teams\n//e.g. obj = Team.findOne...\n//e.g. collection = \"team\"\nfunction contains(userObjs, obj, collection)\n{\n  id = collection+'Id';\n\n  if(typeof userObjs == \"undefined\" || !userObjs.length)\n  {\n    return false;\n  }\n  for (const [count, hash] of Object.entries(userObjs))\n  {\n    if (hash[id] === obj._id)\n    {\n      return true;\n    }\n  }\n  return false;\n}\nmodule.exports = {\n\n// This function adds groups as organizations or teams to users and\n// creates them if not already existing\n// DEFAULT after creation orgIsActive & teamIsActive: true\n// PODC provider needs to send group data within \"wekanGroup\" scope\n// PARAMS to be set for groups within your Oidc provider:\n//  isAdmin: [true, false] -> admin group becomes admin in wekan\n//  isOrganization: [true, false] -> creates org and adds to user\n//  displayName: \"string\"\naddGroupsWithAttributes: function (user, groups){\n  teamArray=[];\n  orgArray=[];\n  isAdmin = [];\n  teams = user.teams;\n  orgs = user.orgs;\n  for (group of groups)\n  {\n    initAttributes = [\n      group.displayName,\n      group.desc || group.displayName,\n      group.shortName ||group.displayName,\n      group.website || group.displayName, group.isActive || false];\n\n    isOrg = group.isOrganisation || false;\n    forceCreate = group.forceCreate|| false;\n    isAdmin.push(group.isAdmin || false);\n    if (isOrg)\n    {\n      org = Org.findOne({\"orgDisplayName\": group.displayName});\n      if(org)\n      {\n        if(contains(orgs, org, \"org\"))\n        {\n          initAttributes.unshift(org);\n          updateObject(initAttributes, \"Org\");\n          continue;\n        }\n      }\n      else if(forceCreate)\n      {\n        createObject(initAttributes, \"Org\");\n        org = Org.findOne({'orgDisplayName': group.displayName});\n      }\n      else\n      {\n        continue;\n      }\n      orgHash = {'orgId': org._id, 'orgDisplayName': group.displayName};\n      orgArray.push(orgHash);\n    }\n\n    else\n    {\n      //start team routine\n      team = Team.findOne({\"teamDisplayName\": group.displayName});\n      if (team)\n      {\n        if(contains(teams, team, \"team\"))\n        {\n          initAttributes.unshift(team);\n          updateObject(initAttributes, \"Team\");\n          continue;\n        }\n      }\n      else if(forceCreate)\n      {\n        createObject(initAttributes, \"Team\");\n        team = Team.findOne({'teamDisplayName': group.displayName});\n      }\n      else\n      {\n        continue;\n      }\n      teamHash = {'teamId': team._id, 'teamDisplayName': group.displayName};\n      teamArray.push(teamHash);\n    }\n  }\n  // user is assigned to team/org which has set isAdmin: true in oidc data\n  // hence user will get admin privileges in wekan\n  // E.g. Admin rights will be withdrawn if no group in oidc provider has isAdmin set to true\n\n  users.update({ _id: user._id }, { $set:  {isAdmin: isAdmin.some(i => (i === true))}});\n  teams = {'teams': {'$each': teamArray}};\n  orgs = {'orgs': {'$each': orgArray}};\n  users.update({ _id: user._id }, { $push:  teams});\n  users.update({ _id: user._id }, { $push:  orgs});\n  // remove temporary oidc data from user collection\n  users.update({ _id: user._id }, { $unset:  {\"services.oidc.groups\": []}});\n\n  return;\n},\n\nchangeUsername: function(user, name)\n{\n  username = {'username': name};\n  if (user.username != username) users.update({ _id: user._id }, { $set:  username});\n},\nchangeFullname: function(user, name)\n{\n  username = {'profile.fullname': name};\n  if (user.username != username) users.update({ _id: user._id }, { $set:  username});\n},\naddEmail: function(user, email)\n{\n  user_email = user.emails || [];\n  var contained = false;\n  position = 0;\n  for (const [count, mail_hash] of Object.entries(user_email))\n  {\n    if (mail_hash['address'] === email)\n    {\n      contained = true;\n      position = count;\n      break;\n    }\n  }\n  if(contained && position != 0)\n  {\n    user_email.splice(position,1);\n    contained = false;\n  }\n  if(!contained)\n  {\n    user_email.unshift({'address': email, 'verified': true});\n    user_email = {'emails': user_email};\n    users.update({ _id: user._id }, { $set:  user_email});\n  }\n}\n}\n"]}